% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{article}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\hypersetup{
  pdftitle={Variuos results for hypothesis testing},
  pdfauthor={Iyar Lin},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}
\urlstyle{same} % disable monospaced font for URLs
\usepackage[margin=1in]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs}
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}

\title{Variuos results for hypothesis testing}
\author{Iyar Lin}
\date{02 June, 2020}

\begin{document}
\maketitle

{
\setcounter{tocdepth}{3}
\tableofcontents
}
\emph{Note: All entries in the table of contents are hyperlinks}

\hypertarget{intro}{%
\section{Intro}\label{intro}}

This document contains proofs and formulas for several use cases
encountered by the author in the context of experimental design. Some
background in Statistics is preferable for understanding some of the
results (You're welcome to contact the
\href{mailto:iyarlin@gmail.com}{author} in case you'd like to get more
clarifications).

The first few sections contain proofs. Section
\protect\hyperlink{formulas}{Formulas for combining min required lift,
number of sides and number of hypothesis tests} contains unified
formulae along with simulation validation.

\hypertarget{notations}{%
\section{Notations}\label{notations}}

Let a control population samples be denoted by:
\(X_1, \dots X_{n_0} \sim Ber(p_0)\) where \(Ber(p_0)\) is the Bernoulli
distribution (meaning \(P(X_i = 1) = p_0\) and conversely
\(P(X_i = 0) = 1- p_0\)).

We similarly denote the treatment population by
\(Y_1, \dots Y_{n_1} \sim Ber(p_1)\).

We'd like to test weather applying the treatment results in any kind of
lift.

Formally we'd like to test the null hypothesis

\[H_0:p_1-p_0 \leq 0\]

vs the alternative:

\[H_1:p_1-p_0 > 0\]

We estimate the population distribution parameter \(p\) using the
population mean:

\[\hat{p_0} = \frac{\sum X_j}{n_0}, \hat{p_1} = \frac{\sum Y_j}{n_1}\]
We note that the ``hat'' in \(\hat{p_i}\) means this is a random
variable which is aimed at estimating the unknown parameter \(p_i\).

Given that \(\hat{p_1}\) is greater ``enough'' then \(\hat{p_0}\) we can
conclude that we should reject the null \(H_0\) and accept the
alternative \(H_1\).

When rejecting the null we'd like to ensure that the probability we
wrongly do so does not exceed some probability \(\alpha\) (often 0.05).

\hypertarget{constructing-the-test}{%
\section{Constructing the test}\label{constructing-the-test}}

\hypertarget{one-sided-test}{%
\subsection{One sided test}\label{one-sided-test}}

To that end we'll construct a test such that we reject the null if the
difference \(\hat{p_1} - \hat{p_0}\) exceeds some critical value \(C\)
with probability \(\alpha\) when the null is in fact true:

\[P_{H_0}(\hat{p}_1-\hat{p}_0>C)=\alpha\] The above probability is also
called type 1 error.

We now turn to finding \(C\).

We can subtract the mean (which is 0 under the null) from both sides of
the inequality and divide by the standard deviation of
\(\hat{p}_1-\hat{p}_0\):

\[P_{H_0}\left(\frac{\hat{p}_1-\hat{p}_0}{SD(\hat{p}_1-\hat{p}_0)}>\frac{C}{SD(\hat{p}_1-\hat{p}_0)}\right)=\alpha\]

where \(SD(\hat{p}_1-\hat{p}_0)\) denotes the standard deviation of
\(\hat{p}_1-\hat{p}_0\).

We note that according to the
\href{https://en.wikipedia.org/wiki/Central_limit_theorem}{central limit
therom}:

\[\frac{\hat{p}_1-\hat{p}_0}{SD(\hat{p}_1-\hat{p}_0)} \underset{n \rightarrow\infty}{\rightsquigarrow} \mathcal{N}(0,1)\]
This means that \(\frac{C}{SD(\hat{p}_1-\hat{p}_0)}\) should equal the
\(\alpha\) quantile of the standard normal distribution (in the case of
\(\alpha = 0.05\) we have \(\Phi^{-1}(0.95) = 1.65\)):

\[\frac{C}{SD(\hat{p}_1-\hat{p}_0)} = \Phi^{-1}(1 - \alpha) \Rightarrow C = \Phi^{-1}(1 - \alpha) \cdot SD(\hat{p}_1-\hat{p}_0)\]
We use the unpooled variance estimator:

\[SD(\hat{p}_1-\hat{p}_0) = \sqrt{p_1(1-p_1)/n_1 + p_0(1-p_0)/n_0}\] and
\textbf{finally}

\[\boxed{C = \Phi^{-1}(1 - \alpha) \cdot \sqrt{\hat{p}_1(1-\hat{p}_1)/n_1 + \hat{p}_0(1-\hat{p}_0)/n_0}}\]

\hypertarget{sided-hypothesis-test}{%
\subsection{2 sided hypothesis test}\label{sided-hypothesis-test}}

If we we'd like to test if either populations has higher \(p\) (not
necessarily treatment higher than control like in the previous section)
we'd be doing what's called a 2 sided hypothesis test:

\[H_0: p_1-p_0 = 0\]

vs

\[H_1: p_1-p_0 \neq 0\]

In this case we'd be constructing a test of the form:

\[P_{H_0}(|\hat{p}_1-\hat{p}_0|>C^{two})=\alpha\] Which translates to

\[P_{H_0}(\hat{p}_1-\hat{p}_0>C^{two} \, \cup \hat{p}_0 - \hat{p}_1 < -C^{two})=\alpha\]
The events \(\hat{p}_1-\hat{p}_0>C^{two}\) and
\(\hat{p}_0 - \hat{p}_1 < -C^{two}\) are disjoint thus we have

\[P_{H_0}(\hat{p}_1-\hat{p}_0>C^{two} \, \cup \hat{p}_0 - \hat{p}_1 < -C^{two}) = P_{H_0}(\hat{p}_1-\hat{p}_0>C^{two}) + P_{H_0}(\hat{p}_0 - \hat{p}_1 < -C^{two}) =\alpha\]

From symmetry of the Gaussian distribution we get that

\[P_{H_0}(\hat{p}_1-\hat{p}_0>C^{two}) = P_{H_0}(\hat{p}_0 - \hat{p}_1 < -C^{two}) = \frac{\alpha}{2}\]

Using the same calculations from the last section we get:

\[\boxed{C^{two} = \Phi^{-1}\left(1 - \frac{\alpha}{2}\right) \cdot \sqrt{\hat{p}_1(1-\hat{p}_1)/n_1 + \hat{p}_0(1-\hat{p}_0)/n_0}}\]

\hypertarget{requiring-minimum-lift}{%
\subsection{Requiring minimum lift}\label{requiring-minimum-lift}}

Sometimes instead of testing \(p_1 > p_0\), we'd like to test a more
demanding criteria \(p_1 > p_0 + \gamma\) where \(\gamma\) is some
minimum required lift (e.g.~if applying the treatment costs us money
such as in the case of direct mail pieces we'd like the treatment lift
to be "at least as high as \(\gamma\)).

We'll thus test:

\[H_0:p_1-p_0 \leq \gamma\]

vs the alternative:

\[H_1:p_1-p_0 > \gamma\]

Now in order to standardize our statistic we'd subtract \(gamma\)
instead of 0:

\[P_{H_0}\left(\frac{\hat{p}_1-\hat{p}_0}{SD(\hat{p}_1-\hat{p}_0)}>\frac{C - \gamma}{SD(\hat{p}_1-\hat{p}_0)}\right)=\alpha\]
We next have

\[\frac{C - \gamma}{SD(\hat{p}_1-\hat{p}_0)} = \Phi^{-1}(1 - \alpha) \Rightarrow C - \gamma = \Phi^{-1}(1 - \alpha) \cdot SD(\hat{p}_1-\hat{p}_0)\]
And finally:

\[\boxed{C = \Phi^{-1}(1 - \alpha) \cdot \sqrt{\hat{p}_1(1-\hat{p}_1)/n_1 + \hat{p}_0(1-\hat{p}_0)/n_0} + \gamma}\]

\hypertarget{power}{%
\section{Power}\label{power}}

Let's assume that in reality the alternative is true (so
\(p_1 - p_0 > 0\)).

We denote by \(\beta\) the probability of \textbf{not} rejecting the
null (also known as type 2 error):

\[\beta = P_{H_1}\left(\hat{p}_1-\hat{p}_0 < C\right)\]

We can then again subtract the mean and divide by the standard deviation
(this time under \(H_1\)) and write:

\[\beta = P_{H_1}\left(\frac{\hat{p}_1-\hat{p}_0 - (p_1 - p_0)}{SD(\hat{p_1} - \hat{p_0})} < \frac{C - (p_1 - p_0)}{SD(\hat{p_1} - \hat{p_0})} \right)\]
We note that according to the
\href{https://en.wikipedia.org/wiki/Central_limit_theorem}{central limit
therom}:

\[\frac{\hat{p}_1-\hat{p}_0 - (p_1 - p_0)}{SD(\hat{p_1} - \hat{p_0})} \underset{n \rightarrow\infty}{\rightsquigarrow} \mathcal{N}(0,1)\]
We can thus write the below equation:

\[\Phi^{-1}(\beta) = \frac{C - (p_1 - p_0)}{SD(\hat{p_1} - \hat{p_0})} \Rightarrow \beta = \Phi\left(\frac{C - (p_1 - p_0)}{SD(\hat{p_1} - \hat{p_0})}\right)\]
We can think about the test \textbf{power} as the probability of
detecting the treatment effect (or conversely, not making the type 2
error \(\beta\)). We thus have that power is equal to \(1-\beta\) and:

\[1 - \beta  = 1 - \Phi\left(\frac{C - (p_1 - p_0)}{SD(\hat{p_1} - \hat{p_0})}\right)\]

And finally the test power is:

\[\boxed{1- \beta = 1 - \Phi\left(\frac{\Phi^{-1}(1 - \alpha) \cdot \sqrt{p_1(1-p_1)/n_1 + p_0(1-p_0)/n_0} - (p_1 - p_0)}{\sqrt{p_1(1-p_1)/n_1 + p_0(1-p_0)/n_0}}\right)}\]
We can usually have a good ``guess'' regarding \(p_0\) based on past
data. \(p_1\) is usually derived from the required minimum detectable
effect such that \(p_1 = p_0 + MDE\) and this is how it's implemented as
a function.

\hypertarget{mde-minimum-detectable-effect}{%
\section{MDE (minimum detectable
effect)}\label{mde-minimum-detectable-effect}}

Often times it's useful to choose a sample size and power and see what
MDE they yield. Let's find the formula.

Starting from the equation arrived at in the
\protect\hyperlink{power}{power} section:

\[\Phi^{-1}(\beta) = \frac{C - (p_1 - p_0)}{SD(\hat{p_1} - \hat{p_0})}\]

We can further develop:

\[\Phi^{-1}(\beta) \cdot \sqrt{p_1(1-p_1)/n_1 + p_0(1-p_0)/n_0} =  \Phi^{-1}(1 - \alpha) \cdot \sqrt{p_1(1-p_1)/n_1 + p_0(1-p_0)/n_0} - (p_1-p_0) \Rightarrow \]

\[p_1-p_0 = (\Phi^{-1}(1 - \alpha) - \Phi^{-1}(\beta))\sqrt{p_1(1-p_1)/n_1 + p_0(1-p_0)/n_0}\]
Finally, using the fact that under \(H_0\) we have \(p_1=p_0\) we get:

\[\boxed{MDE = p_1-p_0 = \left(\Phi^{-1}(1 - \alpha) - \Phi^{-1}(\beta)\right)\sqrt{p_0(1-p_0)/n_1 + p_0(1-p_0)/n_0}}\]

\hypertarget{required-minimum-sample-size}{%
\section{Required minimum sample
size}\label{required-minimum-sample-size}}

Most often, an important part of an experiment design is calculating
required sample sizes.

In this section we'll find the formula for calculating required minimum
sample size assuming the treatment and control group samples are equal
(equal samples sizes yield the highest power as demonstrated in section
2). Let's assume we'd like to obtain a test with power of \(1-\beta\).
Using the result from section 2 we can rearrange (also denote
\(n_0 = n_1 = n\)):

\[\beta = \Phi\left(\frac{\Phi^{-1}(1 - \alpha) \cdot \sqrt{\left(p_1(1-p_1) + p_0(1-p_0)\right)/n} - (p_1 - p_0)}{\sqrt{(p_1(1-p_1) + p_0(1-p_0))/n}}\right) \Rightarrow\]

\[\Phi^{-1}(\beta) = \frac{\Phi^{-1}(1 - \alpha) \cdot \sqrt{\left(p_1(1-p_1) + p_0(1-p_0)\right)/n} - (p_1 - p_0)}{\sqrt{(p_1(1-p_1) + p_0(1-p_0))/n}} \Rightarrow\]

\[\Phi^{-1}(\beta) \cdot \sqrt{(p_1(1-p_1) + p_0(1-p_0))/n} + (p_1 - p_0) = \\ \Phi^{-1}(1 - \alpha) \cdot \sqrt{\left(p_1(1-p_1) + p_0(1-p_0)\right)/n} \Rightarrow\]
\[(p_1 - p_0) = \\ \Phi^{-1}(1 - \alpha) \cdot \sqrt{\left(p_1(1-p_1) + p_0(1-p_0)\right)/n} - \Phi^{-1}(\beta) \cdot \sqrt{(p_1(1-p_1) + p_0(1-p_0))/n} \Rightarrow\]

\[(p_1 - p_0) = \\ \left(\Phi^{-1}(1 - \alpha) - \Phi^{-1}(\beta)\right)\sqrt{(p_1(1-p_1) + p_0(1-p_0))/n} \]

\[\sqrt{n} = \frac{\left(\Phi^{-1}(1 - \alpha) - \Phi^{-1}(\beta)\right)\sqrt{p_1(1-p_1) + p_0(1-p_0)}}{(p_1 - p_0)}\]

And \textbf{finally}:

\[\boxed{n = \left(\frac{\left(\Phi^{-1}(1 - \alpha) - \Phi^{-1}(\beta)\right)\sqrt{p_1(1-p_1) + p_0(1-p_0)}}{(p_1 - p_0)}\right)^2}\]
We can usually have a good ``guess'' regarding \(p_0\) based on past
data. \(p_1\) is usually derived from the required minimum detectable
effect such that \(p_1 = p_0 + MDE\) and this is how it's implemented as
a function.

\hypertarget{formulas}{%
\section{Formulas for combining min required lift, number of sides and
number of hypothesis tests}\label{formulas}}

Below we can see the formulas presented above combining min required
lift \(\gamma\), number of sides \(s \in \{1,2\}\) and number of
hypothesis tests \(h \in \mathbb{N}\) (Using Bonferroni correction for
multiple hypothesis testing).

\hypertarget{critical-value}{%
\subsection{Critical value}\label{critical-value}}

The below is true for all cases \textbf{except}
\(s = 2 \cap \gamma \neq0\).

\[\boxed{C = \Phi^{-1}(1 - \frac{\alpha}{(s\cdot h}) \cdot \sqrt{\hat{p}_1(1-\hat{p}_1)/n_1 + \hat{p}_0(1-\hat{p}_0)/n_0} + \gamma}\]

\hypertarget{simulation-validation}{%
\subsubsection{Simulation validation}\label{simulation-validation}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{rm}\NormalTok{(}\DataTypeTok{list =} \KeywordTok{ls}\NormalTok{())}
\NormalTok{critical_value <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat, n_}\DecValTok{1}\NormalTok{, p_}\DecValTok{0}\NormalTok{_hat, n_}\DecValTok{0}\NormalTok{, alpha, s, h, gamma) \{}
  \CommentTok{# validate inputs}
  \ControlFlowTok{if}\NormalTok{ (}\OperatorTok{!}\NormalTok{s }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{)) }\KeywordTok{stop}\NormalTok{(}\StringTok{"s has to be either 1 or 2"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (h }\OperatorTok{!=}\StringTok{ }\KeywordTok{round}\NormalTok{(h) }\OperatorTok{|}\StringTok{ }\NormalTok{h }\OperatorTok{<}\StringTok{ }\DecValTok{1}\NormalTok{) }\KeywordTok{stop}\NormalTok{(}\StringTok{"h must be a positive integer"}\NormalTok{)}

  \CommentTok{# validate test logic}
  \ControlFlowTok{if}\NormalTok{ (s }\OperatorTok{==}\StringTok{ }\DecValTok{2} \OperatorTok{&}\StringTok{ }\NormalTok{gamma }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{) }\KeywordTok{stop}\NormalTok{(}\StringTok{"In 2 sided tests (s=2) gamma must be equal or greater than 0"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (s }\OperatorTok{==}\StringTok{ }\DecValTok{2} \OperatorTok{&}\StringTok{ }\NormalTok{gamma }\OperatorTok{>}\StringTok{ }\DecValTok{0}\NormalTok{) \{}
\NormalTok{    s <-}\StringTok{ }\DecValTok{1}
\NormalTok{  \}}

  \KeywordTok{qnorm}\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{alpha }\OperatorTok{/}\StringTok{ }\NormalTok{(s }\OperatorTok{*}\StringTok{ }\NormalTok{h)) }\OperatorTok{*}
\StringTok{    }\KeywordTok{sqrt}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{1}\NormalTok{_hat) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{1} \OperatorTok{+}
\StringTok{      }\NormalTok{p_}\DecValTok{0}\NormalTok{_hat }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{0}\NormalTok{_hat) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{0}\NormalTok{) }\OperatorTok{+}\StringTok{ }\NormalTok{gamma}
\NormalTok{\}}

\NormalTok{p_}\DecValTok{0}\NormalTok{ <-}\StringTok{ }\FloatTok{0.2}
\NormalTok{p_}\DecValTok{1}\NormalTok{ <-}\StringTok{ }\FloatTok{0.2} \CommentTok{# Null is true}
\NormalTok{n_}\DecValTok{0}\NormalTok{ <-}\StringTok{ }\DecValTok{8000}
\NormalTok{n_}\DecValTok{1}\NormalTok{ <-}\StringTok{ }\DecValTok{12000}
\NormalTok{alpha <-}\StringTok{ }\FloatTok{0.05}

\NormalTok{s <-}\StringTok{ }\DecValTok{1}\OperatorTok{:}\DecValTok{2}
\NormalTok{h <-}\StringTok{ }\DecValTok{1}\OperatorTok{:}\DecValTok{5}
\NormalTok{gamma <-}\StringTok{ }\KeywordTok{seq}\NormalTok{(}\OperatorTok{-}\FloatTok{0.03}\NormalTok{, }\FloatTok{0.02}\NormalTok{, }\FloatTok{0.01}\NormalTok{)}
\NormalTok{M <-}\StringTok{ }\DecValTok{10000}
\NormalTok{rejected_null <-}\StringTok{ }\KeywordTok{array}\NormalTok{(}
  \DataTypeTok{dim =} \KeywordTok{c}\NormalTok{(}\KeywordTok{length}\NormalTok{(h), }\KeywordTok{length}\NormalTok{(gamma), }\KeywordTok{length}\NormalTok{(s)),}
  \DataTypeTok{dimnames =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"#tests = "}\NormalTok{, h), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"gamma = "}\NormalTok{, gamma), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"sides = "}\NormalTok{, s))}
\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{dim}\NormalTok{(rejected_null)[}\DecValTok{1}\NormalTok{]) \{}
  \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{dim}\NormalTok{(rejected_null)[}\DecValTok{2}\NormalTok{]) \{}
    \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{dim}\NormalTok{(rejected_null)[}\DecValTok{3}\NormalTok{]) \{}
      \ControlFlowTok{if}\NormalTok{ (s[k] }\OperatorTok{==}\StringTok{ }\DecValTok{2} \OperatorTok{&}\StringTok{ }\NormalTok{gamma[j] }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{) }\ControlFlowTok{next}
\NormalTok{      p_}\DecValTok{1}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(}\KeywordTok{replicate}\NormalTok{(}
        \DataTypeTok{n =}\NormalTok{ h[i],}
        \KeywordTok{rbinom}\NormalTok{(M, }\DataTypeTok{size =}\NormalTok{ n_}\DecValTok{1}\NormalTok{, }\DataTypeTok{prob =}\NormalTok{ p_}\DecValTok{1} \OperatorTok{+}\StringTok{ }\NormalTok{gamma[j]) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{1}
\NormalTok{      ), }\DataTypeTok{ncol =}\NormalTok{ h[i])}

\NormalTok{      p_}\DecValTok{0}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(}\KeywordTok{replicate}\NormalTok{(}
        \DataTypeTok{n =}\NormalTok{ h[i],}
        \KeywordTok{rbinom}\NormalTok{(M, }\DataTypeTok{size =}\NormalTok{ n_}\DecValTok{0}\NormalTok{, }\DataTypeTok{prob =}\NormalTok{ p_}\DecValTok{0}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{0}
\NormalTok{      ), }\DataTypeTok{ncol =}\NormalTok{ h[i])}
\NormalTok{      const <-}\StringTok{ }\KeywordTok{mapply}\NormalTok{(}
        \ControlFlowTok{function}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat, p_}\DecValTok{0}\NormalTok{_hat) \{}
          \KeywordTok{critical_value}\NormalTok{(}
            \DataTypeTok{p_1_hat =}\NormalTok{ p_}\DecValTok{1}\NormalTok{_hat, }\DataTypeTok{n_1 =} \KeywordTok{rep}\NormalTok{(n_}\DecValTok{1}\NormalTok{, M),}
            \DataTypeTok{p_0_hat =}\NormalTok{ p_}\DecValTok{0}\NormalTok{_hat, }\DataTypeTok{n_0 =} \KeywordTok{rep}\NormalTok{(n_}\DecValTok{0}\NormalTok{, M),}
            \DataTypeTok{alpha =}\NormalTok{ alpha, }\DataTypeTok{s =}\NormalTok{ s[k], }\DataTypeTok{h =}\NormalTok{ h[i],}
            \DataTypeTok{gamma =}\NormalTok{ gamma[j]}
\NormalTok{          )}
\NormalTok{        \},}
        \KeywordTok{split}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat, }\KeywordTok{rep}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat),}
          \DataTypeTok{each =} \KeywordTok{nrow}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat)}
\NormalTok{        )),}
        \KeywordTok{split}\NormalTok{(p_}\DecValTok{0}\NormalTok{_hat, }\KeywordTok{rep}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(p_}\DecValTok{0}\NormalTok{_hat),}
          \DataTypeTok{each =} \KeywordTok{nrow}\NormalTok{(p_}\DecValTok{0}\NormalTok{_hat)}
\NormalTok{        ))}
\NormalTok{      )}

      \ControlFlowTok{if}\NormalTok{ (s[k] }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{) \{}
\NormalTok{        diff <-}\StringTok{ }\KeywordTok{abs}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat }\OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{0}\NormalTok{_hat)}
\NormalTok{      \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{        diff <-}\StringTok{ }\NormalTok{p_}\DecValTok{1}\NormalTok{_hat }\OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{0}\NormalTok{_hat}
\NormalTok{      \}}

\NormalTok{      rejected_null[i, j, k] <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(}\KeywordTok{apply}\NormalTok{(diff }\OperatorTok{-}\StringTok{ }\NormalTok{const, }\DecValTok{1}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(row) }\KeywordTok{any}\NormalTok{(row }\OperatorTok{>}\StringTok{ }\DecValTok{0}\NormalTok{)))}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Below we can see the results:

\begin{longtable}[]{@{}ccccccc@{}}
\caption{sides = 1}\tabularnewline
\toprule
\begin{minipage}[b]{0.13\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.03\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.02\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.01\strut
\end{minipage} & \begin{minipage}[b]{0.09\columnwidth}\centering
gamma = 0\strut
\end{minipage} & \begin{minipage}[b]{0.11\columnwidth}\centering
gamma = 0.01\strut
\end{minipage} & \begin{minipage}[b]{0.11\columnwidth}\centering
gamma = 0.02\strut
\end{minipage}\tabularnewline
\midrule
\endfirsthead
\toprule
\begin{minipage}[b]{0.13\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.03\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.02\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.01\strut
\end{minipage} & \begin{minipage}[b]{0.09\columnwidth}\centering
gamma = 0\strut
\end{minipage} & \begin{minipage}[b]{0.11\columnwidth}\centering
gamma = 0.01\strut
\end{minipage} & \begin{minipage}[b]{0.11\columnwidth}\centering
gamma = 0.02\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.13\columnwidth}\centering
\textbf{\#tests = 1}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.0522\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.051\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.0499\strut
\end{minipage} & \begin{minipage}[t]{0.09\columnwidth}\centering
0.0496\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
0.052\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
0.0505\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.13\columnwidth}\centering
\textbf{\#tests = 2}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.0491\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.0518\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.0485\strut
\end{minipage} & \begin{minipage}[t]{0.09\columnwidth}\centering
0.046\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
0.0517\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
0.0451\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.13\columnwidth}\centering
\textbf{\#tests = 3}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.0502\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.0517\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.0502\strut
\end{minipage} & \begin{minipage}[t]{0.09\columnwidth}\centering
0.0511\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
0.0493\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
0.0555\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.13\columnwidth}\centering
\textbf{\#tests = 4}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.0529\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.0515\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.0506\strut
\end{minipage} & \begin{minipage}[t]{0.09\columnwidth}\centering
0.0488\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
0.0528\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
0.0503\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.13\columnwidth}\centering
\textbf{\#tests = 5}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.0525\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.0529\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.0476\strut
\end{minipage} & \begin{minipage}[t]{0.09\columnwidth}\centering
0.0497\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
0.0492\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
0.0498\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

\begin{longtable}[]{@{}ccccccc@{}}
\caption{sides = 2}\tabularnewline
\toprule
\begin{minipage}[b]{0.13\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.03\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.02\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.01\strut
\end{minipage} & \begin{minipage}[b]{0.09\columnwidth}\centering
gamma = 0\strut
\end{minipage} & \begin{minipage}[b]{0.11\columnwidth}\centering
gamma = 0.01\strut
\end{minipage} & \begin{minipage}[b]{0.11\columnwidth}\centering
gamma = 0.02\strut
\end{minipage}\tabularnewline
\midrule
\endfirsthead
\toprule
\begin{minipage}[b]{0.13\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.03\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.02\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.01\strut
\end{minipage} & \begin{minipage}[b]{0.09\columnwidth}\centering
gamma = 0\strut
\end{minipage} & \begin{minipage}[b]{0.11\columnwidth}\centering
gamma = 0.01\strut
\end{minipage} & \begin{minipage}[b]{0.11\columnwidth}\centering
gamma = 0.02\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.13\columnwidth}\centering
\textbf{\#tests = 1}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.09\columnwidth}\centering
0.0496\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
0.05\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
0.0502\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.13\columnwidth}\centering
\textbf{\#tests = 2}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.09\columnwidth}\centering
0.0464\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
0.0495\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
0.0476\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.13\columnwidth}\centering
\textbf{\#tests = 3}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.09\columnwidth}\centering
0.0485\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
0.0511\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
0.0474\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.13\columnwidth}\centering
\textbf{\#tests = 4}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.09\columnwidth}\centering
0.0479\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
0.0491\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
0.0518\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.13\columnwidth}\centering
\textbf{\#tests = 5}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.09\columnwidth}\centering
0.0472\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
0.0516\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
0.0505\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

\hypertarget{power-1}{%
\subsection{Power}\label{power-1}}

\[\boxed{1- \beta = 1 - \Phi\left(\frac{\Phi^{-1}(1 - \frac{\alpha}{s\cdot h}) \cdot \sqrt{p_1(1-p_1)/n_1 + p_0(1-p_0)/n_0} - (p_1 - (p_0 + \gamma))}{\sqrt{p_1(1-p_1)/n_1 + p_0(1-p_0)/n_0}}\right)}\]

\hypertarget{simulation-validation-1}{%
\subsubsection{Simulation validation}\label{simulation-validation-1}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{power <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(mde, n_}\DecValTok{1}\NormalTok{, p_}\DecValTok{0}\NormalTok{, n_}\DecValTok{0}\NormalTok{, alpha, s, h, gamma) \{}
  \CommentTok{# validate inputs}
  \ControlFlowTok{if}\NormalTok{ (}\OperatorTok{!}\NormalTok{s }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{)) }\KeywordTok{stop}\NormalTok{(}\StringTok{"s has to be either 1 or 2"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (h }\OperatorTok{!=}\StringTok{ }\KeywordTok{round}\NormalTok{(h) }\OperatorTok{|}\StringTok{ }\NormalTok{h }\OperatorTok{<}\StringTok{ }\DecValTok{1}\NormalTok{) }\KeywordTok{stop}\NormalTok{(}\StringTok{"h must be a positive integer"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (mde }\OperatorTok{<=}\StringTok{ }\NormalTok{gamma) }\KeywordTok{stop}\NormalTok{(}\StringTok{"mde always has to be greater than gamma"}\NormalTok{)}

  \CommentTok{# validate test logic}
  \ControlFlowTok{if}\NormalTok{ (s }\OperatorTok{==}\StringTok{ }\DecValTok{2} \OperatorTok{&}\StringTok{ }\NormalTok{gamma }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{) }\KeywordTok{stop}\NormalTok{(}\StringTok{"In 2 sided tests (s=2) gamma must be equal or greater than 0"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (s }\OperatorTok{==}\StringTok{ }\DecValTok{2} \OperatorTok{&}\StringTok{ }\NormalTok{mde }\OperatorTok{<=}\StringTok{ }\DecValTok{0}\NormalTok{) }\KeywordTok{stop}\NormalTok{(}\StringTok{"In 2 sided tests (s=2) mde must be greater than 0"}\NormalTok{)}

  \DecValTok{1} \OperatorTok{-}\StringTok{ }\KeywordTok{pnorm}\NormalTok{((}\KeywordTok{critical_value}\NormalTok{(p_}\DecValTok{1}\NormalTok{, n_}\DecValTok{1}\NormalTok{, p_}\DecValTok{0}\NormalTok{, n_}\DecValTok{0}\NormalTok{, alpha, s, h, gamma) }\OperatorTok{-}
\StringTok{    }\NormalTok{(p_}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{0}\NormalTok{)) }\OperatorTok{/}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(p_}\DecValTok{1} \OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{1}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{1} \OperatorTok{+}\StringTok{ }\NormalTok{p_}\DecValTok{0} \OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{0}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{0}\NormalTok{))}
\NormalTok{\}}

\NormalTok{p_}\DecValTok{0}\NormalTok{ <-}\StringTok{ }\FloatTok{0.2}
\NormalTok{n_}\DecValTok{0}\NormalTok{ <-}\StringTok{ }\DecValTok{8000}
\NormalTok{n_}\DecValTok{1}\NormalTok{ <-}\StringTok{ }\DecValTok{12000}
\NormalTok{alpha <-}\StringTok{ }\FloatTok{0.05}
\NormalTok{coef <-}\StringTok{ }\FloatTok{1.45}
\NormalTok{s <-}\StringTok{ }\DecValTok{1}\OperatorTok{:}\DecValTok{2}
\NormalTok{h <-}\StringTok{ }\DecValTok{1}\OperatorTok{:}\DecValTok{5}
\NormalTok{gamma <-}\StringTok{ }\KeywordTok{seq}\NormalTok{(}\OperatorTok{-}\FloatTok{0.03}\NormalTok{, }\FloatTok{0.02}\NormalTok{, }\FloatTok{0.01}\NormalTok{)}
\NormalTok{M <-}\StringTok{ }\DecValTok{10000}

\NormalTok{rejected_null_calc_power <-}\StringTok{ }\KeywordTok{array}\NormalTok{(}
  \DataTypeTok{dim =} \KeywordTok{c}\NormalTok{(}\KeywordTok{length}\NormalTok{(h), }\KeywordTok{length}\NormalTok{(gamma), }\KeywordTok{length}\NormalTok{(s)),}
  \DataTypeTok{dimnames =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"#tests = "}\NormalTok{, h), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"gamma = "}\NormalTok{, gamma), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"sides = "}\NormalTok{, s))}
\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{dim}\NormalTok{(rejected_null)[}\DecValTok{1}\NormalTok{]) \{}
  \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{dim}\NormalTok{(rejected_null)[}\DecValTok{2}\NormalTok{]) \{}
    \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{dim}\NormalTok{(rejected_null)[}\DecValTok{3}\NormalTok{]) \{}
      \ControlFlowTok{if}\NormalTok{ (s[k] }\OperatorTok{==}\StringTok{ }\DecValTok{2} \OperatorTok{&}\StringTok{ }\NormalTok{gamma[j] }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{) \{}
        \ControlFlowTok{next}
\NormalTok{      \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (s[k] }\OperatorTok{==}\StringTok{ }\DecValTok{1} \OperatorTok{&}\StringTok{ }\NormalTok{gamma[j] }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{) \{}
\NormalTok{        mde <-}\StringTok{ }\NormalTok{gamma[j] }\OperatorTok{-}\StringTok{ }\NormalTok{(coef }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{) }\OperatorTok{*}\StringTok{ }\NormalTok{gamma[j]}
\NormalTok{      \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (gamma[j] }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{) \{}
\NormalTok{        mde <-}\StringTok{ }\FloatTok{0.01} \OperatorTok{*}\StringTok{ }\NormalTok{coef}
\NormalTok{      \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{        mde <-}\StringTok{ }\NormalTok{gamma[j] }\OperatorTok{*}\StringTok{ }\NormalTok{coef}
\NormalTok{      \}}
\NormalTok{      p_}\DecValTok{1}\NormalTok{ <-}\StringTok{ }\NormalTok{p_}\DecValTok{0} \OperatorTok{+}\StringTok{ }\NormalTok{mde}
\NormalTok{      p_}\DecValTok{1}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(}\KeywordTok{replicate}\NormalTok{(}
        \DataTypeTok{n =}\NormalTok{ h[i],}
        \KeywordTok{rbinom}\NormalTok{(M, }\DataTypeTok{size =}\NormalTok{ n_}\DecValTok{1}\NormalTok{, }\DataTypeTok{prob =}\NormalTok{ p_}\DecValTok{1}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{1}
\NormalTok{      ), }\DataTypeTok{ncol =}\NormalTok{ h[i])}

\NormalTok{      p_}\DecValTok{0}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(}\KeywordTok{replicate}\NormalTok{(}
        \DataTypeTok{n =}\NormalTok{ h[i],}
        \KeywordTok{rbinom}\NormalTok{(M, }\DataTypeTok{size =}\NormalTok{ n_}\DecValTok{0}\NormalTok{, }\DataTypeTok{prob =}\NormalTok{ p_}\DecValTok{0}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{0}
\NormalTok{      ), }\DataTypeTok{ncol =}\NormalTok{ h[i])}
\NormalTok{      const <-}\StringTok{ }\KeywordTok{mapply}\NormalTok{(}
        \ControlFlowTok{function}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat, p_}\DecValTok{0}\NormalTok{_hat) \{}
          \KeywordTok{critical_value}\NormalTok{(}
            \DataTypeTok{p_1_hat =}\NormalTok{ p_}\DecValTok{1}\NormalTok{_hat, }\DataTypeTok{n_1 =} \KeywordTok{rep}\NormalTok{(n_}\DecValTok{1}\NormalTok{, M),}
            \DataTypeTok{p_0_hat =}\NormalTok{ p_}\DecValTok{0}\NormalTok{_hat, }\DataTypeTok{n_0 =} \KeywordTok{rep}\NormalTok{(n_}\DecValTok{0}\NormalTok{, M),}
            \DataTypeTok{alpha =}\NormalTok{ alpha, }\DataTypeTok{s =}\NormalTok{ s[k], }\DataTypeTok{h =}\NormalTok{ h[i],}
            \DataTypeTok{gamma =}\NormalTok{ gamma[j]}
\NormalTok{          )}
\NormalTok{        \},}
        \KeywordTok{split}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat, }\KeywordTok{rep}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat),}
          \DataTypeTok{each =} \KeywordTok{nrow}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat)}
\NormalTok{        )),}
        \KeywordTok{split}\NormalTok{(p_}\DecValTok{0}\NormalTok{_hat, }\KeywordTok{rep}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(p_}\DecValTok{0}\NormalTok{_hat),}
          \DataTypeTok{each =} \KeywordTok{nrow}\NormalTok{(p_}\DecValTok{0}\NormalTok{_hat)}
\NormalTok{        ))}
\NormalTok{      )}

      \ControlFlowTok{if}\NormalTok{ (s[k] }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{) \{}
\NormalTok{        diff <-}\StringTok{ }\KeywordTok{abs}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat }\OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{0}\NormalTok{_hat)}
\NormalTok{      \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{        diff <-}\StringTok{ }\NormalTok{p_}\DecValTok{1}\NormalTok{_hat }\OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{0}\NormalTok{_hat}
\NormalTok{      \}}

\NormalTok{      rejected_null_calc_power[i, j, k] <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(}
        \StringTok{"calc = "}\NormalTok{,}
        \KeywordTok{round}\NormalTok{(}\KeywordTok{power}\NormalTok{(}
          \DataTypeTok{p_0 =}\NormalTok{ p_}\DecValTok{0}\NormalTok{,}
          \DataTypeTok{mde =}\NormalTok{ mde,}
          \DataTypeTok{n_1 =}\NormalTok{ n_}\DecValTok{1}\NormalTok{,}
          \DataTypeTok{n_0 =}\NormalTok{ n_}\DecValTok{0}\NormalTok{,}
          \DataTypeTok{alpha =}\NormalTok{ alpha,}
          \DataTypeTok{s =}\NormalTok{ s[k],}
          \DataTypeTok{h =}\NormalTok{ h[i],}
          \DataTypeTok{gamma =}\NormalTok{ gamma[j]}
\NormalTok{        ), }\DecValTok{3}\NormalTok{),}
        \StringTok{", actual = "}\NormalTok{,}
        \KeywordTok{round}\NormalTok{(}\KeywordTok{mean}\NormalTok{(}\KeywordTok{apply}\NormalTok{(}
\NormalTok{          diff }\OperatorTok{-}\StringTok{ }\NormalTok{const, }\DecValTok{1}\NormalTok{,}
          \ControlFlowTok{function}\NormalTok{(row) \{}
\NormalTok{            row[}\DecValTok{1}\NormalTok{] }\OperatorTok{>}\StringTok{ }\DecValTok{0}
\NormalTok{          \}}
\NormalTok{        )), }\DecValTok{3}\NormalTok{)}
\NormalTok{      )}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Below we can see the results:

\begin{longtable}[]{@{}ccccccc@{}}
\caption{sides = 1}\tabularnewline
\toprule
\begin{minipage}[b]{0.07\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.03\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.02\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.01\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = 0\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = 0.01\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = 0.02\strut
\end{minipage}\tabularnewline
\midrule
\endfirsthead
\toprule
\begin{minipage}[b]{0.07\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.03\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.02\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.01\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = 0\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = 0.01\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = 0.02\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.07\columnwidth}\centering
\textbf{\#tests = 1}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.765, actual = 0.761\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.471, actual = 0.473\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.194, actual = 0.191\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.8, actual = 0.804\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.191, actual = 0.191\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.453, actual = 0.455\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\centering
\textbf{\#tests = 2}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.659, actual = 0.656\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.349, actual = 0.344\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.12, actual = 0.123\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.7, actual = 0.695\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.117, actual = 0.118\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.333, actual = 0.329\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\centering
\textbf{\#tests = 3}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.595, actual = 0.597\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.289, actual = 0.292\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.089, actual = 0.088\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.64, actual = 0.636\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.087, actual = 0.085\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.274, actual = 0.281\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\centering
\textbf{\#tests = 4}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.551, actual = 0.548\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.252, actual = 0.252\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.072, actual = 0.07\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.596, actual = 0.604\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.071, actual = 0.07\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.238, actual = 0.244\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\centering
\textbf{\#tests = 5}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.517, actual = 0.509\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.225, actual = 0.224\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.061, actual = 0.061\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.563, actual = 0.553\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.06, actual = 0.059\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
calc = 0.212, actual = 0.212\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

\begin{longtable}[]{@{}ccccccc@{}}
\caption{sides = 2}\tabularnewline
\toprule
\begin{minipage}[b]{0.09\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.08\columnwidth}\centering
gamma = -0.03\strut
\end{minipage} & \begin{minipage}[b]{0.08\columnwidth}\centering
gamma = -0.02\strut
\end{minipage} & \begin{minipage}[b]{0.08\columnwidth}\centering
gamma = -0.01\strut
\end{minipage} & \begin{minipage}[b]{0.16\columnwidth}\centering
gamma = 0\strut
\end{minipage} & \begin{minipage}[b]{0.16\columnwidth}\centering
gamma = 0.01\strut
\end{minipage} & \begin{minipage}[b]{0.16\columnwidth}\centering
gamma = 0.02\strut
\end{minipage}\tabularnewline
\midrule
\endfirsthead
\toprule
\begin{minipage}[b]{0.09\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.08\columnwidth}\centering
gamma = -0.03\strut
\end{minipage} & \begin{minipage}[b]{0.08\columnwidth}\centering
gamma = -0.02\strut
\end{minipage} & \begin{minipage}[b]{0.08\columnwidth}\centering
gamma = -0.01\strut
\end{minipage} & \begin{minipage}[b]{0.16\columnwidth}\centering
gamma = 0\strut
\end{minipage} & \begin{minipage}[b]{0.16\columnwidth}\centering
gamma = 0.01\strut
\end{minipage} & \begin{minipage}[b]{0.16\columnwidth}\centering
gamma = 0.02\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.09\columnwidth}\centering
\textbf{\#tests = 1}\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
calc = 0.7, actual = 0.698\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
calc = 0.191, actual = 0.194\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
calc = 0.453, actual = 0.458\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.09\columnwidth}\centering
\textbf{\#tests = 2}\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
calc = 0.596, actual = 0.599\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
calc = 0.117, actual = 0.123\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
calc = 0.333, actual = 0.326\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.09\columnwidth}\centering
\textbf{\#tests = 3}\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
calc = 0.536, actual = 0.533\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
calc = 0.087, actual = 0.092\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
calc = 0.274, actual = 0.271\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.09\columnwidth}\centering
\textbf{\#tests = 4}\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
calc = 0.495, actual = 0.496\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
calc = 0.071, actual = 0.074\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
calc = 0.238, actual = 0.246\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.09\columnwidth}\centering
\textbf{\#tests = 5}\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
calc = 0.464, actual = 0.464\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
calc = 0.06, actual = 0.062\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
calc = 0.212, actual = 0.217\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

\hypertarget{mde}{%
\subsection{MDE}\label{mde}}

\[\boxed{MDE = p_1-p_0 = \\ \left(\Phi^{-1}(1 - \frac{\alpha}{s\cdot h}) - \Phi^{-1}(\beta)\right)\sqrt{p_0(1-p_0)/n_1 + p_0(1-p_0)/n_0} + \gamma}\]

\hypertarget{simulation-validation-2}{%
\subsubsection{Simulation validation}\label{simulation-validation-2}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{MDE <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(power, n_}\DecValTok{1}\NormalTok{, p_}\DecValTok{0}\NormalTok{, n_}\DecValTok{0}\NormalTok{, alpha, s, h, gamma) \{}
  \CommentTok{# validate inputs}
  \ControlFlowTok{if}\NormalTok{ (}\OperatorTok{!}\NormalTok{s }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{)) }\KeywordTok{stop}\NormalTok{(}\StringTok{"s has to be either 1 or 2"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (h }\OperatorTok{!=}\StringTok{ }\KeywordTok{round}\NormalTok{(h) }\OperatorTok{|}\StringTok{ }\NormalTok{h }\OperatorTok{<}\StringTok{ }\DecValTok{1}\NormalTok{) }\KeywordTok{stop}\NormalTok{(}\StringTok{"h must be a positive integer"}\NormalTok{)}

  \CommentTok{# validate test logic}
  \ControlFlowTok{if}\NormalTok{ (s }\OperatorTok{==}\StringTok{ }\DecValTok{2} \OperatorTok{&}\StringTok{ }\NormalTok{gamma }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{) }\KeywordTok{stop}\NormalTok{(}\StringTok{"In 2 sided tests (s=2) gamma must be equal or greater than 0"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (s }\OperatorTok{==}\StringTok{ }\DecValTok{2} \OperatorTok{&}\StringTok{ }\NormalTok{gamma }\OperatorTok{>}\StringTok{ }\DecValTok{0}\NormalTok{) s <-}\StringTok{ }\DecValTok{1}

\NormalTok{  (}\KeywordTok{qnorm}\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{alpha }\OperatorTok{/}\StringTok{ }\NormalTok{(s }\OperatorTok{*}\StringTok{ }\NormalTok{h)) }\OperatorTok{-}\StringTok{ }\KeywordTok{qnorm}\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{power)) }\OperatorTok{*}
\StringTok{    }\KeywordTok{sqrt}\NormalTok{(p_}\DecValTok{0} \OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{0}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{1} \OperatorTok{+}\StringTok{ }\NormalTok{p_}\DecValTok{0} \OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{0}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{0}\NormalTok{) }\OperatorTok{+}\StringTok{ }\NormalTok{gamma}
\NormalTok{\}}

\NormalTok{p_}\DecValTok{0}\NormalTok{ <-}\StringTok{ }\FloatTok{0.2}
\NormalTok{n_}\DecValTok{0}\NormalTok{ <-}\StringTok{ }\DecValTok{8000}
\NormalTok{n_}\DecValTok{1}\NormalTok{ <-}\StringTok{ }\DecValTok{12000}
\NormalTok{alpha <-}\StringTok{ }\FloatTok{0.05}
\NormalTok{s <-}\StringTok{ }\DecValTok{1}\OperatorTok{:}\DecValTok{2}
\NormalTok{h <-}\StringTok{ }\DecValTok{1}\OperatorTok{:}\DecValTok{5}
\NormalTok{gamma <-}\StringTok{ }\KeywordTok{seq}\NormalTok{(}\OperatorTok{-}\FloatTok{0.03}\NormalTok{, }\FloatTok{0.02}\NormalTok{, }\FloatTok{0.01}\NormalTok{)}
\NormalTok{M <-}\StringTok{ }\DecValTok{10000}
\NormalTok{pow <-}\StringTok{ }\FloatTok{0.8}
\NormalTok{rejected_null_calc_MDE <-}\StringTok{ }\KeywordTok{array}\NormalTok{(}
  \DataTypeTok{dim =} \KeywordTok{c}\NormalTok{(}\KeywordTok{length}\NormalTok{(h), }\KeywordTok{length}\NormalTok{(gamma), }\KeywordTok{length}\NormalTok{(s)),}
  \DataTypeTok{dimnames =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"#tests = "}\NormalTok{, h), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"gamma = "}\NormalTok{, gamma), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"sides = "}\NormalTok{, s))}
\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{dim}\NormalTok{(rejected_null)[}\DecValTok{1}\NormalTok{]) \{}
  \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{dim}\NormalTok{(rejected_null)[}\DecValTok{2}\NormalTok{]) \{}
    \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{dim}\NormalTok{(rejected_null)[}\DecValTok{3}\NormalTok{]) \{}
      \ControlFlowTok{if}\NormalTok{ (s[k] }\OperatorTok{==}\StringTok{ }\DecValTok{2} \OperatorTok{&}\StringTok{ }\NormalTok{gamma[j] }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{) }\ControlFlowTok{next}
\NormalTok{      mde <-}\StringTok{ }\KeywordTok{MDE}\NormalTok{(}
        \DataTypeTok{power =}\NormalTok{ pow, }\DataTypeTok{n_1 =}\NormalTok{ n_}\DecValTok{1}\NormalTok{, }\DataTypeTok{n_0 =}\NormalTok{ n_}\DecValTok{0}\NormalTok{, }\DataTypeTok{p_0 =}\NormalTok{ p_}\DecValTok{0}\NormalTok{, }\DataTypeTok{alpha =}\NormalTok{ alpha,}
        \DataTypeTok{s =}\NormalTok{ s[k], }\DataTypeTok{h =}\NormalTok{ h[i], }\DataTypeTok{gamma =}\NormalTok{ gamma[j]}
\NormalTok{      )}
\NormalTok{      p_}\DecValTok{1}\NormalTok{ <-}\StringTok{ }\NormalTok{p_}\DecValTok{0} \OperatorTok{+}\StringTok{ }\NormalTok{mde }\CommentTok{# MDE is true}

\NormalTok{      p_}\DecValTok{1}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(}\KeywordTok{replicate}\NormalTok{(}
        \DataTypeTok{n =}\NormalTok{ h[i],}
        \KeywordTok{rbinom}\NormalTok{(M, }\DataTypeTok{size =}\NormalTok{ n_}\DecValTok{1}\NormalTok{, }\DataTypeTok{prob =}\NormalTok{ p_}\DecValTok{1}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{1}
\NormalTok{      ), }\DataTypeTok{ncol =}\NormalTok{ h[i])}

\NormalTok{      p_}\DecValTok{0}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(}\KeywordTok{replicate}\NormalTok{(}
        \DataTypeTok{n =}\NormalTok{ h[i],}
        \KeywordTok{rbinom}\NormalTok{(M, }\DataTypeTok{size =}\NormalTok{ n_}\DecValTok{0}\NormalTok{, }\DataTypeTok{prob =}\NormalTok{ p_}\DecValTok{0}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{0}
\NormalTok{      ), }\DataTypeTok{ncol =}\NormalTok{ h[i])}
\NormalTok{      const <-}\StringTok{ }\KeywordTok{mapply}\NormalTok{(}
        \ControlFlowTok{function}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat, p_}\DecValTok{0}\NormalTok{_hat) \{}
          \KeywordTok{critical_value}\NormalTok{(}
            \DataTypeTok{p_1_hat =}\NormalTok{ p_}\DecValTok{1}\NormalTok{_hat, }\DataTypeTok{n_1 =} \KeywordTok{rep}\NormalTok{(n_}\DecValTok{1}\NormalTok{, M),}
            \DataTypeTok{p_0_hat =}\NormalTok{ p_}\DecValTok{0}\NormalTok{_hat, }\DataTypeTok{n_0 =} \KeywordTok{rep}\NormalTok{(n_}\DecValTok{0}\NormalTok{, M),}
            \DataTypeTok{alpha =}\NormalTok{ alpha, }\DataTypeTok{s =}\NormalTok{ s[k], }\DataTypeTok{h =}\NormalTok{ h[i],}
            \DataTypeTok{gamma =}\NormalTok{ gamma[j]}
\NormalTok{          )}
\NormalTok{        \},}
        \KeywordTok{split}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat, }\KeywordTok{rep}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat),}
          \DataTypeTok{each =} \KeywordTok{nrow}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat)}
\NormalTok{        )),}
        \KeywordTok{split}\NormalTok{(p_}\DecValTok{0}\NormalTok{_hat, }\KeywordTok{rep}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(p_}\DecValTok{0}\NormalTok{_hat),}
          \DataTypeTok{each =} \KeywordTok{nrow}\NormalTok{(p_}\DecValTok{0}\NormalTok{_hat)}
\NormalTok{        ))}
\NormalTok{      )}

      \ControlFlowTok{if}\NormalTok{ (s[k] }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{) \{}
\NormalTok{        diff <-}\StringTok{ }\KeywordTok{abs}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat }\OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{0}\NormalTok{_hat)}
\NormalTok{      \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{        diff <-}\StringTok{ }\NormalTok{p_}\DecValTok{1}\NormalTok{_hat }\OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{0}\NormalTok{_hat}
\NormalTok{      \}}

\NormalTok{      rejected_null_calc_MDE[i, j, k] <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(}
        \StringTok{"MDE = "}\NormalTok{,}
        \KeywordTok{round}\NormalTok{(mde, }\DecValTok{4}\NormalTok{),}
        \StringTok{", rejected = "}\NormalTok{,}
        \KeywordTok{round}\NormalTok{(}\KeywordTok{mean}\NormalTok{(}\KeywordTok{apply}\NormalTok{(}
\NormalTok{          diff }\OperatorTok{-}\StringTok{ }\NormalTok{const, }\DecValTok{1}\NormalTok{,}
          \ControlFlowTok{function}\NormalTok{(row) \{}
\NormalTok{            row[}\DecValTok{1}\NormalTok{] }\OperatorTok{>}\StringTok{ }\DecValTok{0}
\NormalTok{          \}}
\NormalTok{        )), }\DecValTok{3}\NormalTok{)}
\NormalTok{      )}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Below we can see the results:

\begin{longtable}[]{@{}ccccccc@{}}
\caption{sides = 1}\tabularnewline
\toprule
\begin{minipage}[b]{0.06\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.03\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.02\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.01\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = 0\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = 0.01\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = 0.02\strut
\end{minipage}\tabularnewline
\midrule
\endfirsthead
\toprule
\begin{minipage}[b]{0.06\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.03\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.02\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.01\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = 0\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = 0.01\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = 0.02\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.06\columnwidth}\centering
\textbf{\#tests = 1}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = -0.0156, rejected = 0.805\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = -0.0056, rejected = 0.807\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = 0.0044, rejected = 0.796\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = 0.0144, rejected = 0.797\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = 0.0244, rejected = 0.785\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = 0.0344, rejected = 0.785\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.06\columnwidth}\centering
\textbf{\#tests = 2}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = -0.0138, rejected = 0.807\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = -0.0038, rejected = 0.801\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = 0.0062, rejected = 0.796\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = 0.0162, rejected = 0.79\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = 0.0262, rejected = 0.786\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = 0.0362, rejected = 0.778\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.06\columnwidth}\centering
\textbf{\#tests = 3}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = -0.0129, rejected = 0.815\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = -0.0029, rejected = 0.798\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = 0.0071, rejected = 0.799\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = 0.0171, rejected = 0.788\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = 0.0271, rejected = 0.78\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = 0.0371, rejected = 0.776\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.06\columnwidth}\centering
\textbf{\#tests = 4}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = -0.0122, rejected = 0.809\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = -0.0022, rejected = 0.793\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = 0.0078, rejected = 0.791\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = 0.0178, rejected = 0.782\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = 0.0278, rejected = 0.783\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = 0.0378, rejected = 0.776\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.06\columnwidth}\centering
\textbf{\#tests = 5}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = -0.0117, rejected = 0.81\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = -0.0017, rejected = 0.8\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = 0.0083, rejected = 0.794\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = 0.0183, rejected = 0.783\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = 0.0283, rejected = 0.775\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
MDE = 0.0383, rejected = 0.774\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

\begin{longtable}[]{@{}ccccccc@{}}
\caption{sides = 2}\tabularnewline
\toprule
\begin{minipage}[b]{0.08\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.08\columnwidth}\centering
gamma = -0.03\strut
\end{minipage} & \begin{minipage}[b]{0.08\columnwidth}\centering
gamma = -0.02\strut
\end{minipage} & \begin{minipage}[b]{0.08\columnwidth}\centering
gamma = -0.01\strut
\end{minipage} & \begin{minipage}[b]{0.16\columnwidth}\centering
gamma = 0\strut
\end{minipage} & \begin{minipage}[b]{0.16\columnwidth}\centering
gamma = 0.01\strut
\end{minipage} & \begin{minipage}[b]{0.16\columnwidth}\centering
gamma = 0.02\strut
\end{minipage}\tabularnewline
\midrule
\endfirsthead
\toprule
\begin{minipage}[b]{0.08\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.08\columnwidth}\centering
gamma = -0.03\strut
\end{minipage} & \begin{minipage}[b]{0.08\columnwidth}\centering
gamma = -0.02\strut
\end{minipage} & \begin{minipage}[b]{0.08\columnwidth}\centering
gamma = -0.01\strut
\end{minipage} & \begin{minipage}[b]{0.16\columnwidth}\centering
gamma = 0\strut
\end{minipage} & \begin{minipage}[b]{0.16\columnwidth}\centering
gamma = 0.01\strut
\end{minipage} & \begin{minipage}[b]{0.16\columnwidth}\centering
gamma = 0.02\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.08\columnwidth}\centering
\textbf{\#tests = 1}\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
MDE = 0.0162, rejected = 0.791\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
MDE = 0.0244, rejected = 0.783\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
MDE = 0.0344, rejected = 0.784\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.08\columnwidth}\centering
\textbf{\#tests = 2}\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
MDE = 0.0178, rejected = 0.789\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
MDE = 0.0262, rejected = 0.787\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
MDE = 0.0362, rejected = 0.783\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.08\columnwidth}\centering
\textbf{\#tests = 3}\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
MDE = 0.0187, rejected = 0.787\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
MDE = 0.0271, rejected = 0.784\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
MDE = 0.0371, rejected = 0.782\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.08\columnwidth}\centering
\textbf{\#tests = 4}\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
MDE = 0.0193, rejected = 0.785\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
MDE = 0.0278, rejected = 0.777\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
MDE = 0.0378, rejected = 0.775\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.08\columnwidth}\centering
\textbf{\#tests = 5}\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
MDE = 0.0197, rejected = 0.781\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
MDE = 0.0283, rejected = 0.78\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
MDE = 0.0383, rejected = 0.772\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

\hypertarget{required-minimum-sample-size-1}{%
\subsection{Required minimum sample
size}\label{required-minimum-sample-size-1}}

\[\boxed{n = \left(\frac{\left(\Phi^{-1}(1 - \frac{\alpha}{s \cdot h}) - \Phi^{-1}(\beta)\right)\sqrt{p_1(1-p_1) + p_0(1-p_0)}}{(p_1 - (p_0 + \gamma))}\right)^2}\]

\hypertarget{simulation-validation-3}{%
\subsubsection{Simulation validation}\label{simulation-validation-3}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{min_sample_size <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(mde, p_}\DecValTok{0}\NormalTok{, alpha, s, h, gamma, power) \{}
  \CommentTok{# validate inputs}
  \ControlFlowTok{if}\NormalTok{ (}\OperatorTok{!}\NormalTok{s }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{)) }\KeywordTok{stop}\NormalTok{(}\StringTok{"s has to be either 1 or 2"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (h }\OperatorTok{!=}\StringTok{ }\KeywordTok{round}\NormalTok{(h) }\OperatorTok{|}\StringTok{ }\NormalTok{h }\OperatorTok{<}\StringTok{ }\DecValTok{1}\NormalTok{) }\KeywordTok{stop}\NormalTok{(}\StringTok{"h must be a positive integer"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (mde }\OperatorTok{<=}\StringTok{ }\NormalTok{gamma) }\KeywordTok{stop}\NormalTok{(}\StringTok{"mde always has to be greater than gamma"}\NormalTok{)}

  \CommentTok{# validate test logic}
  \ControlFlowTok{if}\NormalTok{ (s }\OperatorTok{==}\StringTok{ }\DecValTok{2} \OperatorTok{&}\StringTok{ }\NormalTok{gamma }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{) }\KeywordTok{stop}\NormalTok{(}\StringTok{"In 2 sided tests (s=2) gamma must be equal or greater than 0"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (s }\OperatorTok{==}\StringTok{ }\DecValTok{2} \OperatorTok{&}\StringTok{ }\NormalTok{mde }\OperatorTok{<=}\StringTok{ }\DecValTok{0}\NormalTok{) }\KeywordTok{stop}\NormalTok{(}\StringTok{"In 2 sided tests (s=2) mde must be greater than 0"}\NormalTok{)}

\NormalTok{  p_}\DecValTok{1}\NormalTok{ <-}\StringTok{ }\NormalTok{p_}\DecValTok{0} \OperatorTok{+}\StringTok{ }\NormalTok{mde}
  \KeywordTok{round}\NormalTok{((((}\KeywordTok{qnorm}\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{alpha }\OperatorTok{/}\StringTok{ }\NormalTok{(s }\OperatorTok{*}\StringTok{ }\NormalTok{h)) }\OperatorTok{-}\StringTok{ }\KeywordTok{qnorm}\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{power)) }\OperatorTok{*}
\StringTok{    }\KeywordTok{sqrt}\NormalTok{(p_}\DecValTok{1} \OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{1}\NormalTok{) }\OperatorTok{+}\StringTok{ }\NormalTok{p_}\DecValTok{0} \OperatorTok{*}
\StringTok{      }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{0}\NormalTok{))) }\OperatorTok{/}\StringTok{ }\NormalTok{(p_}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{(p_}\DecValTok{0} \OperatorTok{+}\StringTok{ }\NormalTok{gamma)))}\OperatorTok{^}\DecValTok{2}\NormalTok{)}
\NormalTok{\}}

\NormalTok{p_}\DecValTok{0}\NormalTok{ <-}\StringTok{ }\FloatTok{0.2}
\NormalTok{alpha <-}\StringTok{ }\FloatTok{0.05}
\NormalTok{coef <-}\StringTok{ }\FloatTok{1.3}
\NormalTok{s <-}\StringTok{ }\DecValTok{1}\OperatorTok{:}\DecValTok{2}
\NormalTok{h <-}\StringTok{ }\DecValTok{1}\OperatorTok{:}\DecValTok{5}
\NormalTok{gamma <-}\StringTok{ }\KeywordTok{seq}\NormalTok{(}\OperatorTok{-}\FloatTok{0.03}\NormalTok{, }\FloatTok{0.02}\NormalTok{, }\FloatTok{0.01}\NormalTok{)}
\NormalTok{M <-}\StringTok{ }\DecValTok{10000}
\NormalTok{pow <-}\StringTok{ }\FloatTok{0.8}

\NormalTok{rejected_null_calc_min_n <-}\StringTok{ }\KeywordTok{array}\NormalTok{(}
  \DataTypeTok{dim =} \KeywordTok{c}\NormalTok{(}\KeywordTok{length}\NormalTok{(h), }\KeywordTok{length}\NormalTok{(gamma), }\KeywordTok{length}\NormalTok{(s)),}
  \DataTypeTok{dimnames =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"#tests = "}\NormalTok{, h), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"gamma = "}\NormalTok{, gamma), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"sides = "}\NormalTok{, s))}
\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{dim}\NormalTok{(rejected_null)[}\DecValTok{1}\NormalTok{]) \{}
  \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{dim}\NormalTok{(rejected_null)[}\DecValTok{2}\NormalTok{]) \{}
    \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{dim}\NormalTok{(rejected_null)[}\DecValTok{3}\NormalTok{]) \{}
      \ControlFlowTok{if}\NormalTok{ (s[k] }\OperatorTok{==}\StringTok{ }\DecValTok{2} \OperatorTok{&}\StringTok{ }\NormalTok{gamma[j] }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{) \{}
        \ControlFlowTok{next}
\NormalTok{      \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (s[k] }\OperatorTok{==}\StringTok{ }\DecValTok{1} \OperatorTok{&}\StringTok{ }\NormalTok{gamma[j] }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{) \{}
\NormalTok{        mde <-}\StringTok{ }\NormalTok{gamma[j] }\OperatorTok{-}\StringTok{ }\NormalTok{(coef }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{) }\OperatorTok{*}\StringTok{ }\NormalTok{gamma[j]}
\NormalTok{      \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (gamma[j] }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{) \{}
\NormalTok{        mde <-}\StringTok{ }\FloatTok{0.01} \OperatorTok{*}\StringTok{ }\NormalTok{coef}
\NormalTok{      \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{        mde <-}\StringTok{ }\NormalTok{gamma[j] }\OperatorTok{*}\StringTok{ }\NormalTok{coef}
\NormalTok{      \}}
\NormalTok{      p_}\DecValTok{1}\NormalTok{ <-}\StringTok{ }\NormalTok{p_}\DecValTok{0} \OperatorTok{+}\StringTok{ }\NormalTok{mde}

\NormalTok{      n_}\DecValTok{0}\NormalTok{ <-}\StringTok{ }\NormalTok{n_}\DecValTok{1}\NormalTok{ <-}\StringTok{ }\KeywordTok{min_sample_size}\NormalTok{(}
        \DataTypeTok{mde =}\NormalTok{ mde, }\DataTypeTok{p_0 =}\NormalTok{ p_}\DecValTok{0}\NormalTok{, }\DataTypeTok{alpha =}\NormalTok{ alpha,}
        \DataTypeTok{s =}\NormalTok{ s[k], }\DataTypeTok{h =}\NormalTok{ h[i], }\DataTypeTok{gamma =}\NormalTok{ gamma[j], }\DataTypeTok{power =}\NormalTok{ pow}
\NormalTok{      )}
\NormalTok{      p_}\DecValTok{1}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(}\KeywordTok{replicate}\NormalTok{(}
        \DataTypeTok{n =}\NormalTok{ h[i],}
        \KeywordTok{rbinom}\NormalTok{(M, }\DataTypeTok{size =}\NormalTok{ n_}\DecValTok{1}\NormalTok{, }\DataTypeTok{prob =}\NormalTok{ p_}\DecValTok{1}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{1}
\NormalTok{      ), }\DataTypeTok{ncol =}\NormalTok{ h[i])}

\NormalTok{      p_}\DecValTok{0}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(}\KeywordTok{replicate}\NormalTok{(}
        \DataTypeTok{n =}\NormalTok{ h[i],}
        \KeywordTok{rbinom}\NormalTok{(M, }\DataTypeTok{size =}\NormalTok{ n_}\DecValTok{0}\NormalTok{, }\DataTypeTok{prob =}\NormalTok{ p_}\DecValTok{0}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{0}
\NormalTok{      ), }\DataTypeTok{ncol =}\NormalTok{ h[i])}
\NormalTok{      const <-}\StringTok{ }\KeywordTok{mapply}\NormalTok{(}
        \ControlFlowTok{function}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat, p_}\DecValTok{0}\NormalTok{_hat) \{}
          \KeywordTok{critical_value}\NormalTok{(}
            \DataTypeTok{p_1_hat =}\NormalTok{ p_}\DecValTok{1}\NormalTok{_hat, }\DataTypeTok{n_1 =} \KeywordTok{rep}\NormalTok{(n_}\DecValTok{1}\NormalTok{, M),}
            \DataTypeTok{p_0_hat =}\NormalTok{ p_}\DecValTok{0}\NormalTok{_hat, }\DataTypeTok{n_0 =} \KeywordTok{rep}\NormalTok{(n_}\DecValTok{0}\NormalTok{, M),}
            \DataTypeTok{alpha =}\NormalTok{ alpha, }\DataTypeTok{s =}\NormalTok{ s[k], }\DataTypeTok{h =}\NormalTok{ h[i],}
            \DataTypeTok{gamma =}\NormalTok{ gamma[j]}
\NormalTok{          )}
\NormalTok{        \},}
        \KeywordTok{split}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat, }\KeywordTok{rep}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat),}
          \DataTypeTok{each =} \KeywordTok{nrow}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat)}
\NormalTok{        )),}
        \KeywordTok{split}\NormalTok{(p_}\DecValTok{0}\NormalTok{_hat, }\KeywordTok{rep}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(p_}\DecValTok{0}\NormalTok{_hat),}
          \DataTypeTok{each =} \KeywordTok{nrow}\NormalTok{(p_}\DecValTok{0}\NormalTok{_hat)}
\NormalTok{        ))}
\NormalTok{      )}

      \ControlFlowTok{if}\NormalTok{ (s[k] }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{) \{}
\NormalTok{        diff <-}\StringTok{ }\KeywordTok{abs}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat }\OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{0}\NormalTok{_hat)}
\NormalTok{      \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{        diff <-}\StringTok{ }\NormalTok{p_}\DecValTok{1}\NormalTok{_hat }\OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{0}\NormalTok{_hat}
\NormalTok{      \}}

\NormalTok{      rejected_null_calc_min_n[i, j, k] <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(}
        \StringTok{"n = "}\NormalTok{,}
\NormalTok{        n_}\DecValTok{0}\NormalTok{,}
        \StringTok{", rejected = "}\NormalTok{,}
        \KeywordTok{round}\NormalTok{(}\KeywordTok{mean}\NormalTok{(}\KeywordTok{apply}\NormalTok{(}
\NormalTok{          diff }\OperatorTok{-}\StringTok{ }\NormalTok{const, }\DecValTok{1}\NormalTok{,}
          \ControlFlowTok{function}\NormalTok{(row) \{}
\NormalTok{            row[}\DecValTok{1}\NormalTok{] }\OperatorTok{>}\StringTok{ }\DecValTok{0}
\NormalTok{          \}}
\NormalTok{        )), }\DecValTok{3}\NormalTok{)}
\NormalTok{      )}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Below we can see the results:

\begin{longtable}[]{@{}ccccccc@{}}
\caption{sides = 1}\tabularnewline
\toprule
\begin{minipage}[b]{0.07\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.03\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.02\strut
\end{minipage} & \begin{minipage}[b]{0.13\columnwidth}\centering
gamma = -0.01\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = 0\strut
\end{minipage} & \begin{minipage}[b]{0.13\columnwidth}\centering
gamma = 0.01\strut
\end{minipage} & \begin{minipage}[b]{0.13\columnwidth}\centering
gamma = 0.02\strut
\end{minipage}\tabularnewline
\midrule
\endfirsthead
\toprule
\begin{minipage}[b]{0.07\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.03\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = -0.02\strut
\end{minipage} & \begin{minipage}[b]{0.13\columnwidth}\centering
gamma = -0.01\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
gamma = 0\strut
\end{minipage} & \begin{minipage}[b]{0.13\columnwidth}\centering
gamma = 0.01\strut
\end{minipage} & \begin{minipage}[b]{0.13\columnwidth}\centering
gamma = 0.02\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.07\columnwidth}\centering
\textbf{\#tests = 1}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
n = 23430, rejected = 0.8\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
n = 53480, rejected = 0.796\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
n = 216905, rejected = 0.801\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
n = 11986, rejected = 0.8\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
n = 225066, rejected = 0.8\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
n = 57519, rejected = 0.8\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\centering
\textbf{\#tests = 2}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
n = 29744, rejected = 0.799\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
n = 67894, rejected = 0.804\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
n = 275366, rejected = 0.802\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
n = 15216, rejected = 0.801\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
n = 285726, rejected = 0.801\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
n = 73022, rejected = 0.797\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\centering
\textbf{\#tests = 3}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
n = 33420, rejected = 0.787\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
n = 76285, rejected = 0.8\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
n = 309398, rejected = 0.799\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
n = 17097, rejected = 0.795\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
n = 321039, rejected = 0.795\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
n = 82046, rejected = 0.801\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\centering
\textbf{\#tests = 4}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
n = 36020, rejected = 0.804\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
n = 82220, rejected = 0.797\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
n = 333469, rejected = 0.795\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
n = 18427, rejected = 0.8\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
n = 346016, rejected = 0.791\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
n = 88430, rejected = 0.802\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\centering
\textbf{\#tests = 5}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
n = 38033, rejected = 0.798\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
n = 86813, rejected = 0.807\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
n = 352098, rejected = 0.798\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
n = 19456, rejected = 0.795\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
n = 365346, rejected = 0.796\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
n = 93370, rejected = 0.801\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

\begin{longtable}[]{@{}ccccccc@{}}
\caption{sides = 2}\tabularnewline
\toprule
\begin{minipage}[b]{0.09\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.08\columnwidth}\centering
gamma = -0.03\strut
\end{minipage} & \begin{minipage}[b]{0.08\columnwidth}\centering
gamma = -0.02\strut
\end{minipage} & \begin{minipage}[b]{0.08\columnwidth}\centering
gamma = -0.01\strut
\end{minipage} & \begin{minipage}[b]{0.15\columnwidth}\centering
gamma = 0\strut
\end{minipage} & \begin{minipage}[b]{0.16\columnwidth}\centering
gamma = 0.01\strut
\end{minipage} & \begin{minipage}[b]{0.16\columnwidth}\centering
gamma = 0.02\strut
\end{minipage}\tabularnewline
\midrule
\endfirsthead
\toprule
\begin{minipage}[b]{0.09\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.08\columnwidth}\centering
gamma = -0.03\strut
\end{minipage} & \begin{minipage}[b]{0.08\columnwidth}\centering
gamma = -0.02\strut
\end{minipage} & \begin{minipage}[b]{0.08\columnwidth}\centering
gamma = -0.01\strut
\end{minipage} & \begin{minipage}[b]{0.15\columnwidth}\centering
gamma = 0\strut
\end{minipage} & \begin{minipage}[b]{0.16\columnwidth}\centering
gamma = 0.01\strut
\end{minipage} & \begin{minipage}[b]{0.16\columnwidth}\centering
gamma = 0.02\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.09\columnwidth}\centering
\textbf{\#tests = 1}\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\centering
n = 15216, rejected = 0.802\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
n = 285726, rejected = 0.88\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
n = 73022, rejected = 0.877\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.09\columnwidth}\centering
\textbf{\#tests = 2}\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\centering
n = 18427, rejected = 0.799\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
n = 346016, rejected = 0.874\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
n = 88430, rejected = 0.865\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.09\columnwidth}\centering
\textbf{\#tests = 3}\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\centering
n = 20296, rejected = 0.804\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
n = 381112, rejected = 0.867\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
n = 97399, rejected = 0.863\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.09\columnwidth}\centering
\textbf{\#tests = 4}\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\centering
n = 21618, rejected = 0.801\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
n = 405939, rejected = 0.864\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
n = 103744, rejected = 0.863\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.09\columnwidth}\centering
\textbf{\#tests = 5}\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.08\columnwidth}\centering
NA\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\centering
n = 22641, rejected = 0.8\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
n = 425155, rejected = 0.862\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
n = 108655, rejected = 0.859\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

\hypertarget{confidence-intervals}{%
\section{Confidence intervals}\label{confidence-intervals}}

Below we have the formula for the confidence interval.

We note it does not included MDE, power or \(\gamma\). As such, it's a
tool to convey estimate uncertainty, rather then for planning an
experiment.

\[\boxed{CI = \hat{p}_1-\hat{p}_0 \pm \Phi^{-1}(1-\frac{\alpha}{2h})\sqrt{\hat{p}_1(1-\hat{p}_1)/n_1+\hat{p}_0(1-\hat{p}_0)/n_0}}\]

\hypertarget{simulation-validation-4}{%
\subsection{Simulation validation}\label{simulation-validation-4}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{CI <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat, n_}\DecValTok{1}\NormalTok{, p_}\DecValTok{0}\NormalTok{_hat, n_}\DecValTok{0}\NormalTok{, alpha, h) \{}
  \CommentTok{# validate inputs}
  \ControlFlowTok{if}\NormalTok{ (h }\OperatorTok{!=}\StringTok{ }\KeywordTok{round}\NormalTok{(h) }\OperatorTok{|}\StringTok{ }\NormalTok{h }\OperatorTok{<}\StringTok{ }\DecValTok{1}\NormalTok{) }\KeywordTok{stop}\NormalTok{(}\StringTok{"h must be a positive integer"}\NormalTok{)}

\NormalTok{  point_estimate <-}\StringTok{ }\NormalTok{p_}\DecValTok{1}\NormalTok{_hat }\OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{0}\NormalTok{_hat}
\NormalTok{  rhs <-}\StringTok{ }\KeywordTok{qnorm}\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{alpha }\OperatorTok{/}\StringTok{ }\NormalTok{(}\DecValTok{2} \OperatorTok{*}\StringTok{ }\NormalTok{h)) }\OperatorTok{*}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{1}\NormalTok{_hat) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{1} \OperatorTok{+}\StringTok{ }\NormalTok{p_}\DecValTok{0}\NormalTok{_hat }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{0}\NormalTok{_hat) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{0}\NormalTok{)}

\NormalTok{  ans <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}
    \DataTypeTok{lower_bound =}\NormalTok{ point_estimate }\OperatorTok{-}\StringTok{ }\NormalTok{rhs,}
    \DataTypeTok{higher_bound =}\NormalTok{ point_estimate }\OperatorTok{+}\StringTok{ }\NormalTok{rhs}
\NormalTok{  )}
  \KeywordTok{return}\NormalTok{(ans)}
\NormalTok{\}}

\NormalTok{p_}\DecValTok{0}\NormalTok{ <-}\StringTok{ }\FloatTok{0.2}
\NormalTok{n_}\DecValTok{0}\NormalTok{ <-}\StringTok{ }\DecValTok{16000}
\NormalTok{n_}\DecValTok{1}\NormalTok{ <-}\StringTok{ }\DecValTok{24000}
\NormalTok{alpha <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\FloatTok{0.05}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{0.25}\NormalTok{)}
\NormalTok{diff <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\OperatorTok{-}\FloatTok{0.02}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FloatTok{0.03}\NormalTok{)}

\NormalTok{h <-}\StringTok{ }\DecValTok{1}\OperatorTok{:}\DecValTok{5}
\NormalTok{M <-}\StringTok{ }\DecValTok{10000}
\NormalTok{CI_coverage <-}\StringTok{ }\KeywordTok{array}\NormalTok{(}
  \DataTypeTok{dim =} \KeywordTok{c}\NormalTok{(}\KeywordTok{length}\NormalTok{(h), }\KeywordTok{length}\NormalTok{(alpha), }\KeywordTok{length}\NormalTok{(diff)),}
  \DataTypeTok{dimnames =} \KeywordTok{list}\NormalTok{(}
    \KeywordTok{paste0}\NormalTok{(}\StringTok{"#tests = "}\NormalTok{, h), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"alpha = "}\NormalTok{, alpha),}
    \KeywordTok{paste0}\NormalTok{(}\StringTok{"diff = "}\NormalTok{, diff)}
\NormalTok{  )}
\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{dim}\NormalTok{(CI_coverage)[}\DecValTok{1}\NormalTok{]) \{}
  \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{dim}\NormalTok{(CI_coverage)[}\DecValTok{2}\NormalTok{]) \{}
    \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{dim}\NormalTok{(CI_coverage)[}\DecValTok{3}\NormalTok{]) \{}
\NormalTok{      p_}\DecValTok{1}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(}\KeywordTok{replicate}\NormalTok{(}
        \DataTypeTok{n =}\NormalTok{ h[i],}
        \KeywordTok{rbinom}\NormalTok{(M, }\DataTypeTok{size =}\NormalTok{ n_}\DecValTok{1}\NormalTok{, }\DataTypeTok{prob =}\NormalTok{ p_}\DecValTok{0} \OperatorTok{+}\StringTok{ }\NormalTok{diff[k]) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{1}
\NormalTok{      ), }\DataTypeTok{ncol =}\NormalTok{ h[i])}

\NormalTok{      p_}\DecValTok{0}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(}\KeywordTok{replicate}\NormalTok{(}
        \DataTypeTok{n =}\NormalTok{ h[i],}
        \KeywordTok{rbinom}\NormalTok{(M, }\DataTypeTok{size =}\NormalTok{ n_}\DecValTok{0}\NormalTok{, }\DataTypeTok{prob =}\NormalTok{ p_}\DecValTok{0}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{0}
\NormalTok{      ), }\DataTypeTok{ncol =}\NormalTok{ h[i])}

\NormalTok{      CI_mat <-}\StringTok{ }\KeywordTok{mapply}\NormalTok{(}
        \ControlFlowTok{function}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat, p_}\DecValTok{0}\NormalTok{_hat) \{}
\NormalTok{          ci <-}\StringTok{ }\KeywordTok{CI}\NormalTok{(}
            \DataTypeTok{p_1_hat =}\NormalTok{ p_}\DecValTok{1}\NormalTok{_hat, }\DataTypeTok{n_1 =} \KeywordTok{rep}\NormalTok{(n_}\DecValTok{1}\NormalTok{, M),}
            \DataTypeTok{p_0_hat =}\NormalTok{ p_}\DecValTok{0}\NormalTok{_hat, }\DataTypeTok{n_0 =} \KeywordTok{rep}\NormalTok{(n_}\DecValTok{0}\NormalTok{, M),}
            \DataTypeTok{alpha =}\NormalTok{ alpha[j], }\DataTypeTok{h =}\NormalTok{ h[i]}
\NormalTok{          )}
\NormalTok{          in_ci <-}\StringTok{ }\NormalTok{ci}\OperatorTok{$}\NormalTok{lower_bound }\OperatorTok{<}\StringTok{ }\NormalTok{diff[k] }\OperatorTok{&}\StringTok{ }\NormalTok{diff[k] }\OperatorTok{<}\StringTok{ }\NormalTok{ci}\OperatorTok{$}\NormalTok{higher_bound}
          \KeywordTok{return}\NormalTok{(in_ci)}
\NormalTok{        \},}
        \KeywordTok{split}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat, }\KeywordTok{rep}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat),}
          \DataTypeTok{each =} \KeywordTok{nrow}\NormalTok{(p_}\DecValTok{1}\NormalTok{_hat)}
\NormalTok{        )),}
        \KeywordTok{split}\NormalTok{(p_}\DecValTok{0}\NormalTok{_hat, }\KeywordTok{rep}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(p_}\DecValTok{0}\NormalTok{_hat),}
          \DataTypeTok{each =} \KeywordTok{nrow}\NormalTok{(p_}\DecValTok{0}\NormalTok{_hat)}
\NormalTok{        ))}
\NormalTok{      )}

\NormalTok{      CI_coverage[i, j, k] <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(}\KeywordTok{apply}\NormalTok{(CI_mat, }\DecValTok{1}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(row) }\KeywordTok{any}\NormalTok{(row }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{)))}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Below we can see the results:

\begin{longtable}[]{@{}ccccc@{}}
\caption{diff = -0.02}\tabularnewline
\toprule
\begin{minipage}[b]{0.19\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.17\columnwidth}\centering
alpha = 0.01\strut
\end{minipage} & \begin{minipage}[b]{0.17\columnwidth}\centering
alpha = 0.05\strut
\end{minipage} & \begin{minipage}[b]{0.16\columnwidth}\centering
alpha = 0.1\strut
\end{minipage} & \begin{minipage}[b]{0.17\columnwidth}\centering
alpha = 0.25\strut
\end{minipage}\tabularnewline
\midrule
\endfirsthead
\toprule
\begin{minipage}[b]{0.19\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.17\columnwidth}\centering
alpha = 0.01\strut
\end{minipage} & \begin{minipage}[b]{0.17\columnwidth}\centering
alpha = 0.05\strut
\end{minipage} & \begin{minipage}[b]{0.16\columnwidth}\centering
alpha = 0.1\strut
\end{minipage} & \begin{minipage}[b]{0.17\columnwidth}\centering
alpha = 0.25\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.19\columnwidth}\centering
\textbf{\#tests = 1}\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.011\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0542\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
0.0972\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.2478\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.19\columnwidth}\centering
\textbf{\#tests = 2}\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0086\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0497\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
0.101\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.2357\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.19\columnwidth}\centering
\textbf{\#tests = 3}\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0094\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0545\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
0.0964\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.2267\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.19\columnwidth}\centering
\textbf{\#tests = 4}\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0096\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0495\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
0.0904\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.2237\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.19\columnwidth}\centering
\textbf{\#tests = 5}\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0094\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0525\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
0.0915\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.2237\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

\begin{longtable}[]{@{}ccccc@{}}
\caption{diff = 0}\tabularnewline
\toprule
\begin{minipage}[b]{0.19\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.17\columnwidth}\centering
alpha = 0.01\strut
\end{minipage} & \begin{minipage}[b]{0.17\columnwidth}\centering
alpha = 0.05\strut
\end{minipage} & \begin{minipage}[b]{0.16\columnwidth}\centering
alpha = 0.1\strut
\end{minipage} & \begin{minipage}[b]{0.17\columnwidth}\centering
alpha = 0.25\strut
\end{minipage}\tabularnewline
\midrule
\endfirsthead
\toprule
\begin{minipage}[b]{0.19\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.17\columnwidth}\centering
alpha = 0.01\strut
\end{minipage} & \begin{minipage}[b]{0.17\columnwidth}\centering
alpha = 0.05\strut
\end{minipage} & \begin{minipage}[b]{0.16\columnwidth}\centering
alpha = 0.1\strut
\end{minipage} & \begin{minipage}[b]{0.17\columnwidth}\centering
alpha = 0.25\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.19\columnwidth}\centering
\textbf{\#tests = 1}\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0108\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0463\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
0.1035\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.247\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.19\columnwidth}\centering
\textbf{\#tests = 2}\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0102\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0502\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
0.0985\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.2233\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.19\columnwidth}\centering
\textbf{\#tests = 3}\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0097\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0481\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
0.095\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.2362\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.19\columnwidth}\centering
\textbf{\#tests = 4}\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0085\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0473\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
0.0941\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.2226\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.19\columnwidth}\centering
\textbf{\#tests = 5}\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0081\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0513\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
0.0921\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.2229\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

\begin{longtable}[]{@{}ccccc@{}}
\caption{diff = 0.03}\tabularnewline
\toprule
\begin{minipage}[b]{0.19\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.17\columnwidth}\centering
alpha = 0.01\strut
\end{minipage} & \begin{minipage}[b]{0.17\columnwidth}\centering
alpha = 0.05\strut
\end{minipage} & \begin{minipage}[b]{0.16\columnwidth}\centering
alpha = 0.1\strut
\end{minipage} & \begin{minipage}[b]{0.17\columnwidth}\centering
alpha = 0.25\strut
\end{minipage}\tabularnewline
\midrule
\endfirsthead
\toprule
\begin{minipage}[b]{0.19\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.17\columnwidth}\centering
alpha = 0.01\strut
\end{minipage} & \begin{minipage}[b]{0.17\columnwidth}\centering
alpha = 0.05\strut
\end{minipage} & \begin{minipage}[b]{0.16\columnwidth}\centering
alpha = 0.1\strut
\end{minipage} & \begin{minipage}[b]{0.17\columnwidth}\centering
alpha = 0.25\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.19\columnwidth}\centering
\textbf{\#tests = 1}\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0092\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0493\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
0.0967\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.2499\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.19\columnwidth}\centering
\textbf{\#tests = 2}\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0118\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0495\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
0.0963\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.2345\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.19\columnwidth}\centering
\textbf{\#tests = 3}\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0098\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0502\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
0.0986\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.2368\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.19\columnwidth}\centering
\textbf{\#tests = 4}\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0099\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0475\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
0.0912\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.2261\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.19\columnwidth}\centering
\textbf{\#tests = 5}\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0095\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.0489\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
0.0914\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\centering
0.2304\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

\hypertarget{testing-with-several-samples}{%
\section{Testing with several
samples}\label{testing-with-several-samples}}

Do note this section isn't implemented yet in the \emph{hype} package.

\hypertarget{notations-1}{%
\subsection{Notations}\label{notations-1}}

Sometimes we'd like to collect several samples and do hypothesis testing
over them.

Formally speaking let's assume we collect samples in 2 periods (this
will be further generalized to T periods later). We have the
populations:

First period control: \[X_1^1, \dots X_{n_0^1}^1 \sim Ber(p_0^1)\] First
period treatment: \[Y_1^1, \dots Y_{n_1^1}^1 \sim Ber(p_1^1)\] Second
period control: \[X_1^2, \dots X_{n_0^2}^2 \sim Ber(p_0^2)\] First
period treatment: \[Y_1^2, \dots Y_{n_0^2}^2 \sim Ber(p_1^2)\] While we
don't assume \(p_0^1 = p_0^2\) or \(p_1^1 = p_1^2\) we do assume that
the lift between treatment and control is the same such that
\(p_1^1 - p_0^1 = p_1^2 - p_0^2 = \delta\).

So far we've really tested

\[H_0: \delta \leq 0\] vs

\[H_1: \delta > 0\] We can estimate the lift using the average of both
periods estimates:

\[\hat{\delta} = \frac{\hat{\delta_1} + \hat{\delta_2}}{2}\] where
\(\hat{\delta_1} = \hat{p}_1^1 - \hat{p}_0^1\) and
\(\hat{\delta_2} = \hat{p}_1^2 - \hat{p}_0^2\).

Let's assume that \(var(\delta_1)<var(\delta_2)\). The question arises:
when should we use \(\hat{\delta}\) instead of \(\hat{\delta}_1\)?

We'd do so when \(var(\hat{\delta}_1) > var(\hat{\delta})\). This
happens when:

\[var(\hat{\delta}_1) > var(\hat{\delta}) = var\left(\frac{\hat{\delta_1} + \hat{\delta_2}}{2}\right) = \frac{1}{4}\left(var(\hat{\delta}_1) + var(\hat{\delta}_2)\right)\]
re-arranging we get

\[3\cdot var(\hat{\delta}_1) > var(\hat{\delta}_2)\] Given \(T\) periods
we can use this logic to choose periods in an inductive way.

\hypertarget{constructing-the-test-1}{%
\subsection{Constructing the test}\label{constructing-the-test-1}}

Again, we'd like to construct a test of the form

\[P_{H_0}(\hat{\delta} > C) = \alpha\]

We note that the standard deviation of our estimator for this case is:

\[SD(\hat{\delta}) = \frac{1}{2}\sqrt{var(\hat{\delta}_1) + var(\hat{\delta}_2)} = \\ \frac{1}{2}\sqrt{p_1^1(1-p_1^1)/n_1^1 + p_0^1(1-p_0^1)/n_0^1 + p_1^2(1 - p_1^2)/n_1^2 + p_0^2(1-p_0^2)/n_0^2}\]

We thus have that our constant is:

\[\boxed{C = \Phi^{-1}(1 - \alpha) \cdot \frac{1}{2}\sqrt{p_1^1(1-p_1^1)/n_1^1 + p_0^1(1-p_0^1)/n_0^1 + p_1^2(1 - p_1^2)/n_1^2 + p_0^2(1-p_0^2)/n_0^2}}\]
Given \(T\) periods used in the test we have:

\[\boxed{C = \Phi^{-1}(1 - \alpha) \cdot \frac{1}{T}\left(var(\delta^1) + var(\delta^2) + \dots + var(\delta^T)\right)}\]

The rest of the results in this document can be found in a similar
manner by swapping the \(SD\) term.

\hypertarget{simulation-validation-5}{%
\subsubsection{Simulation validation}\label{simulation-validation-5}}

Let's validate using 3 periods, different sample sized and base
conversion rates.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{rm}\NormalTok{(}\DataTypeTok{list =} \KeywordTok{ls}\NormalTok{())}
\NormalTok{p_}\DecValTok{01}\NormalTok{ <-}\StringTok{ }\NormalTok{p_}\DecValTok{11}\NormalTok{ <-}\StringTok{ }\FloatTok{0.2} \CommentTok{# Null is true}
\NormalTok{p_}\DecValTok{02}\NormalTok{ <-}\StringTok{ }\NormalTok{p_}\DecValTok{12}\NormalTok{ <-}\StringTok{ }\FloatTok{0.24}
\NormalTok{p_}\DecValTok{03}\NormalTok{ <-}\StringTok{ }\NormalTok{p_}\DecValTok{13}\NormalTok{ <-}\StringTok{ }\FloatTok{0.23}

\NormalTok{n_}\DecValTok{01}\NormalTok{ <-}\StringTok{ }\DecValTok{5000}
\NormalTok{n_}\DecValTok{11}\NormalTok{ <-}\StringTok{ }\DecValTok{7000}
\NormalTok{n_}\DecValTok{02}\NormalTok{ <-}\StringTok{ }\DecValTok{4000}
\NormalTok{n_}\DecValTok{12}\NormalTok{ <-}\StringTok{ }\DecValTok{10000}
\NormalTok{n_}\DecValTok{03}\NormalTok{ <-}\StringTok{ }\DecValTok{3000}
\NormalTok{n_}\DecValTok{13}\NormalTok{ <-}\StringTok{ }\DecValTok{5000}

\NormalTok{alpha <-}\StringTok{ }\FloatTok{0.05}

\NormalTok{M <-}\StringTok{ }\DecValTok{100000} \CommentTok{# number of simulations}
\NormalTok{p_}\DecValTok{01}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{rbinom}\NormalTok{(M, }\DataTypeTok{size =}\NormalTok{ n_}\DecValTok{01}\NormalTok{, }\DataTypeTok{prob =}\NormalTok{ p_}\DecValTok{01}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{01}
\NormalTok{p_}\DecValTok{11}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{rbinom}\NormalTok{(M, }\DataTypeTok{size =}\NormalTok{ n_}\DecValTok{11}\NormalTok{, }\DataTypeTok{prob =}\NormalTok{ p_}\DecValTok{11}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{11}
\NormalTok{p_}\DecValTok{02}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{rbinom}\NormalTok{(M, }\DataTypeTok{size =}\NormalTok{ n_}\DecValTok{02}\NormalTok{, }\DataTypeTok{prob =}\NormalTok{ p_}\DecValTok{02}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{02}
\NormalTok{p_}\DecValTok{12}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{rbinom}\NormalTok{(M, }\DataTypeTok{size =}\NormalTok{ n_}\DecValTok{12}\NormalTok{, }\DataTypeTok{prob =}\NormalTok{ p_}\DecValTok{12}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{12}
\NormalTok{p_}\DecValTok{03}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{rbinom}\NormalTok{(M, }\DataTypeTok{size =}\NormalTok{ n_}\DecValTok{03}\NormalTok{, }\DataTypeTok{prob =}\NormalTok{ p_}\DecValTok{03}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{03}
\NormalTok{p_}\DecValTok{13}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{rbinom}\NormalTok{(M, }\DataTypeTok{size =}\NormalTok{ n_}\DecValTok{13}\NormalTok{, }\DataTypeTok{prob =}\NormalTok{ p_}\DecValTok{13}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{13}

\NormalTok{var_}\DecValTok{1}\NormalTok{_hat <-}\StringTok{ }\NormalTok{p_}\DecValTok{11}\NormalTok{_hat }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{11}\NormalTok{_hat) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{11} \OperatorTok{+}\StringTok{ }\NormalTok{p_}\DecValTok{01}\NormalTok{_hat }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{01}\NormalTok{_hat) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{01}
\NormalTok{var_}\DecValTok{2}\NormalTok{_hat <-}\StringTok{ }\NormalTok{p_}\DecValTok{12}\NormalTok{_hat }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{12}\NormalTok{_hat) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{12} \OperatorTok{+}\StringTok{ }\NormalTok{p_}\DecValTok{02}\NormalTok{_hat }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{02}\NormalTok{_hat) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{02}
\NormalTok{var_}\DecValTok{3}\NormalTok{_hat <-}\StringTok{ }\NormalTok{p_}\DecValTok{13}\NormalTok{_hat }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{13}\NormalTok{_hat) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{13} \OperatorTok{+}\StringTok{ }\NormalTok{p_}\DecValTok{03}\NormalTok{_hat }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{03}\NormalTok{_hat) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{03}

\NormalTok{C <-}\StringTok{ }\KeywordTok{qnorm}\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{alpha) }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{/}\StringTok{ }\DecValTok{3}\NormalTok{) }\OperatorTok{*}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(var_}\DecValTok{1}\NormalTok{_hat }\OperatorTok{+}\StringTok{ }\NormalTok{var_}\DecValTok{2}\NormalTok{_hat }\OperatorTok{+}\StringTok{ }\NormalTok{var_}\DecValTok{3}\NormalTok{_hat)}

\NormalTok{diff <-}\StringTok{ }\NormalTok{((p_}\DecValTok{11}\NormalTok{_hat }\OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{01}\NormalTok{_hat) }\OperatorTok{+}\StringTok{ }\NormalTok{(p_}\DecValTok{12}\NormalTok{_hat }\OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{02}\NormalTok{_hat) }\OperatorTok{+}\StringTok{ }\NormalTok{(p_}\DecValTok{13}\NormalTok{_hat }\OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{03}\NormalTok{_hat)) }\OperatorTok{/}\StringTok{ }\DecValTok{3}
\NormalTok{rejected_null <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(diff }\OperatorTok{>}\StringTok{ }\NormalTok{C)}
\end{Highlighting}
\end{Shaded}

We rejected 0.05036 of simulations. Cool.

\hypertarget{power-2}{%
\subsection{Power}\label{power-2}}

General formula for \(T\) periods is

\[\boxed{1- \beta = 1 - \Phi\left(\frac{\Phi^{-1}(1 - \alpha) \cdot \frac{1}{T} \sqrt{var(\hat{\delta^1}) + var(\hat{\delta^2}) + \dots + var(\hat{\delta^T)}} - \delta)}{\frac{1}{T}\sqrt{var(\hat{\delta^1}) + var(\hat{\delta^2}) + \dots + var(\hat{\delta^T)}}}\right)}\]

Let's validate that!

\hypertarget{simulation-validation-6}{%
\subsubsection{Simulation validation}\label{simulation-validation-6}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{rm}\NormalTok{(}\DataTypeTok{list =} \KeywordTok{ls}\NormalTok{())}
\NormalTok{delta <-}\StringTok{ }\FloatTok{0.003}
\NormalTok{p_}\DecValTok{01}\NormalTok{ <-}\StringTok{ }\FloatTok{0.2}
\NormalTok{p_}\DecValTok{11}\NormalTok{ <-}\StringTok{ }\NormalTok{p_}\DecValTok{01} \OperatorTok{+}\StringTok{ }\NormalTok{delta}
\NormalTok{p_}\DecValTok{02}\NormalTok{ <-}\StringTok{ }\FloatTok{0.24}
\NormalTok{p_}\DecValTok{12}\NormalTok{ <-}\StringTok{ }\NormalTok{p_}\DecValTok{02} \OperatorTok{+}\StringTok{ }\NormalTok{delta}
\NormalTok{p_}\DecValTok{03}\NormalTok{ <-}\StringTok{ }\FloatTok{0.23}
\NormalTok{p_}\DecValTok{13}\NormalTok{ <-}\StringTok{ }\NormalTok{p_}\DecValTok{03} \OperatorTok{+}\StringTok{ }\NormalTok{delta}

\NormalTok{n_}\DecValTok{01}\NormalTok{ <-}\StringTok{ }\DecValTok{5000}
\NormalTok{n_}\DecValTok{11}\NormalTok{ <-}\StringTok{ }\DecValTok{7000}
\NormalTok{n_}\DecValTok{02}\NormalTok{ <-}\StringTok{ }\DecValTok{4000}
\NormalTok{n_}\DecValTok{12}\NormalTok{ <-}\StringTok{ }\DecValTok{10000}
\NormalTok{n_}\DecValTok{03}\NormalTok{ <-}\StringTok{ }\DecValTok{3000}
\NormalTok{n_}\DecValTok{13}\NormalTok{ <-}\StringTok{ }\DecValTok{5000}

\NormalTok{var_}\DecValTok{1}\NormalTok{ <-}\StringTok{ }\NormalTok{p_}\DecValTok{11} \OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{11}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{11} \OperatorTok{+}\StringTok{ }\NormalTok{p_}\DecValTok{01} \OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{01}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{01}
\NormalTok{var_}\DecValTok{2}\NormalTok{ <-}\StringTok{ }\NormalTok{p_}\DecValTok{12} \OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{12}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{12} \OperatorTok{+}\StringTok{ }\NormalTok{p_}\DecValTok{02} \OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{02}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{02}
\NormalTok{var_}\DecValTok{3}\NormalTok{ <-}\StringTok{ }\NormalTok{p_}\DecValTok{13} \OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{13}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{13} \OperatorTok{+}\StringTok{ }\NormalTok{p_}\DecValTok{03} \OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{03}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{03}

\NormalTok{alpha <-}\StringTok{ }\FloatTok{0.05}

\NormalTok{power_calc <-}\StringTok{ }\DecValTok{1} \OperatorTok{-}
\StringTok{  }\KeywordTok{pnorm}\NormalTok{((}\KeywordTok{qnorm}\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{alpha) }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{/}\StringTok{ }\DecValTok{3}\NormalTok{) }\OperatorTok{*}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(var_}\DecValTok{1} \OperatorTok{+}\StringTok{ }\NormalTok{var_}\DecValTok{2} \OperatorTok{+}\StringTok{ }\NormalTok{var_}\DecValTok{3}\NormalTok{) }\OperatorTok{-}\StringTok{ }\NormalTok{delta) }\OperatorTok{/}
\StringTok{    }\NormalTok{((}\DecValTok{1} \OperatorTok{/}\StringTok{ }\DecValTok{3}\NormalTok{) }\OperatorTok{*}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(var_}\DecValTok{1} \OperatorTok{+}\StringTok{ }\NormalTok{var_}\DecValTok{2} \OperatorTok{+}\StringTok{ }\NormalTok{var_}\DecValTok{3}\NormalTok{)))}

\NormalTok{M <-}\StringTok{ }\DecValTok{100000} \CommentTok{# number of simulations}
\NormalTok{p_}\DecValTok{01}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{rbinom}\NormalTok{(M, }\DataTypeTok{size =}\NormalTok{ n_}\DecValTok{01}\NormalTok{, }\DataTypeTok{prob =}\NormalTok{ p_}\DecValTok{01}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{01}
\NormalTok{p_}\DecValTok{11}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{rbinom}\NormalTok{(M, }\DataTypeTok{size =}\NormalTok{ n_}\DecValTok{11}\NormalTok{, }\DataTypeTok{prob =}\NormalTok{ p_}\DecValTok{11}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{11}
\NormalTok{p_}\DecValTok{02}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{rbinom}\NormalTok{(M, }\DataTypeTok{size =}\NormalTok{ n_}\DecValTok{02}\NormalTok{, }\DataTypeTok{prob =}\NormalTok{ p_}\DecValTok{02}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{02}
\NormalTok{p_}\DecValTok{12}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{rbinom}\NormalTok{(M, }\DataTypeTok{size =}\NormalTok{ n_}\DecValTok{12}\NormalTok{, }\DataTypeTok{prob =}\NormalTok{ p_}\DecValTok{12}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{12}
\NormalTok{p_}\DecValTok{03}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{rbinom}\NormalTok{(M, }\DataTypeTok{size =}\NormalTok{ n_}\DecValTok{03}\NormalTok{, }\DataTypeTok{prob =}\NormalTok{ p_}\DecValTok{03}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{03}
\NormalTok{p_}\DecValTok{13}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{rbinom}\NormalTok{(M, }\DataTypeTok{size =}\NormalTok{ n_}\DecValTok{13}\NormalTok{, }\DataTypeTok{prob =}\NormalTok{ p_}\DecValTok{13}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{13}

\NormalTok{var_}\DecValTok{1}\NormalTok{_hat <-}\StringTok{ }\NormalTok{p_}\DecValTok{01}\NormalTok{_hat }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{01}\NormalTok{_hat) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{11} \OperatorTok{+}\StringTok{ }\NormalTok{p_}\DecValTok{01}\NormalTok{_hat }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{01}\NormalTok{_hat) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{01}
\NormalTok{var_}\DecValTok{2}\NormalTok{_hat <-}\StringTok{ }\NormalTok{p_}\DecValTok{02}\NormalTok{_hat }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{02}\NormalTok{_hat) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{12} \OperatorTok{+}\StringTok{ }\NormalTok{p_}\DecValTok{02}\NormalTok{_hat }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{02}\NormalTok{_hat) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{02}
\NormalTok{var_}\DecValTok{3}\NormalTok{_hat <-}\StringTok{ }\NormalTok{p_}\DecValTok{03}\NormalTok{_hat }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{03}\NormalTok{_hat) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{13} \OperatorTok{+}\StringTok{ }\NormalTok{p_}\DecValTok{03}\NormalTok{_hat }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{03}\NormalTok{_hat) }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{03}

\NormalTok{C <-}\StringTok{ }\KeywordTok{qnorm}\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{alpha) }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{/}\StringTok{ }\DecValTok{3}\NormalTok{) }\OperatorTok{*}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(var_}\DecValTok{1}\NormalTok{_hat }\OperatorTok{+}\StringTok{ }\NormalTok{var_}\DecValTok{2}\NormalTok{_hat }\OperatorTok{+}\StringTok{ }\NormalTok{var_}\DecValTok{3}\NormalTok{_hat)}

\NormalTok{diff <-}\StringTok{ }\NormalTok{((p_}\DecValTok{11}\NormalTok{_hat }\OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{01}\NormalTok{_hat) }\OperatorTok{+}\StringTok{ }\NormalTok{(p_}\DecValTok{12}\NormalTok{_hat }\OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{02}\NormalTok{_hat) }\OperatorTok{+}\StringTok{ }\NormalTok{(p_}\DecValTok{13}\NormalTok{_hat }\OperatorTok{-}\StringTok{ }\NormalTok{p_}\DecValTok{03}\NormalTok{_hat)) }\OperatorTok{/}\StringTok{ }\DecValTok{3}
\NormalTok{rejected_null <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(diff }\OperatorTok{>}\StringTok{ }\NormalTok{C)}
\end{Highlighting}
\end{Shaded}

The calculated power is 0.151632. The fraction of rejected simulations
is 0.15429. Pretty close.

\hypertarget{converting-all-results-for-the-continuous-case}{%
\section{Converting all results for the continuous
case}\label{converting-all-results-for-the-continuous-case}}

All results in this document are derived for the binary case.

In case our distributions of interest are continuous with means
\(\mu_0, \mu_1\) and variances \(\sigma^2_0, \sigma^2_1\) (note that
they don't have to be necessarily Gaussian) then all results in this
paper can be used, converting in all formulas:

\[p \rightarrow \mu\]

\[p \rightarrow \mu\]
\[SD(\hat{\mu}_1-\hat{\mu}_0) \rightarrow \sqrt{\sigma^2_0/n_1 + \sigma^2_0/n_0}\]
\[SD(\hat{\mu}_1-\hat{\mu}_0) \rightarrow \sqrt{\sigma^2_1/n_1 + \sigma^2_0/n_0}\]
So for example in the continuous case the test constant \(C\) would be

\[\boxed{C = \Phi^{-1}(1 - \alpha) \cdot \sqrt{\hat{\sigma}^2_0/n_1 + \hat{\sigma}^2_0/n_0}}\]

\hypertarget{simulation-validation-7}{%
\paragraph{Simulation validation}\label{simulation-validation-7}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{rm}\NormalTok{(}\DataTypeTok{list =} \KeywordTok{ls}\NormalTok{())}
\NormalTok{mu_}\DecValTok{0}\NormalTok{ <-}\StringTok{ }\NormalTok{mu_}\DecValTok{1}\NormalTok{ <-}\StringTok{ }\DecValTok{10} \CommentTok{# Null is true}
\NormalTok{sigma_}\DecValTok{0}\NormalTok{ <-}\StringTok{ }\NormalTok{sigma_}\DecValTok{1}\NormalTok{ <-}\StringTok{ }\DecValTok{4}
\NormalTok{n_}\DecValTok{0}\NormalTok{ <-}\StringTok{ }\NormalTok{n_}\DecValTok{1}\NormalTok{ <-}\StringTok{ }\DecValTok{1000}
\NormalTok{alpha <-}\StringTok{ }\FloatTok{0.05}

\NormalTok{M <-}\StringTok{ }\DecValTok{100000} \CommentTok{# number of simulations}
\NormalTok{mu_}\DecValTok{0}\NormalTok{_samples <-}\StringTok{ }\KeywordTok{replicate}\NormalTok{(}\DataTypeTok{n =}\NormalTok{ M, }\KeywordTok{rnorm}\NormalTok{(}\DataTypeTok{n =}\NormalTok{ n_}\DecValTok{0}\NormalTok{, }\DataTypeTok{mean =}\NormalTok{ mu_}\DecValTok{0}\NormalTok{, }\DataTypeTok{sd =} \KeywordTok{sqrt}\NormalTok{(sigma_}\DecValTok{0}\NormalTok{)))}
\NormalTok{mu_}\DecValTok{1}\NormalTok{_samples <-}\StringTok{ }\KeywordTok{replicate}\NormalTok{(}\DataTypeTok{n =}\NormalTok{ M, }\KeywordTok{rnorm}\NormalTok{(}\DataTypeTok{n =}\NormalTok{ n_}\DecValTok{1}\NormalTok{, }\DataTypeTok{mean =}\NormalTok{ mu_}\DecValTok{1}\NormalTok{, }\DataTypeTok{sd =} \KeywordTok{sqrt}\NormalTok{(sigma_}\DecValTok{1}\NormalTok{)))}

\NormalTok{mu_}\DecValTok{0}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(mu_}\DecValTok{0}\NormalTok{_samples, }\DecValTok{2}\NormalTok{, mean)}
\NormalTok{sigma_}\DecValTok{0}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(mu_}\DecValTok{0}\NormalTok{_samples, }\DecValTok{2}\NormalTok{, var)}
\NormalTok{mu_}\DecValTok{1}\NormalTok{_hat <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(mu_}\DecValTok{1}\NormalTok{_samples, }\DecValTok{2}\NormalTok{, mean)}
\NormalTok{C <-}\StringTok{ }\KeywordTok{qnorm}\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{alpha) }\OperatorTok{*}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(}\DecValTok{2} \OperatorTok{*}\StringTok{ }\NormalTok{sigma_}\DecValTok{0}\NormalTok{_hat }\OperatorTok{/}\StringTok{ }\NormalTok{n_}\DecValTok{0}\NormalTok{)}

\NormalTok{diff <-}\StringTok{ }\NormalTok{mu_}\DecValTok{1}\NormalTok{_hat }\OperatorTok{-}\StringTok{ }\NormalTok{mu_}\DecValTok{0}\NormalTok{_hat}
\NormalTok{rejected_null <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(diff }\OperatorTok{>}\StringTok{ }\NormalTok{C)}
\end{Highlighting}
\end{Shaded}

The fraction of simulations we rejected the null was 0.05102, pretty
close to our chosen \(\alpha\) = 0.05.

\end{document}
